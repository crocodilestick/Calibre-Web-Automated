### cwa
- cwa | ccff6bc4c106ac0f0fef3787419dd38ce3c385f9 | 2026-01-30T00:15:50+01:00 | Fix app.db migration lockups during user column updates | Startup logs showed sqlite3.OperationalError: no such column: user.auto_send_enabled, followed by database is locked when the migration tried to ALTER TABLE user to add the missing column. The failing SELECT left the SQLAlchemy session in a dirty state, so the subsequent DDL ran against a locked DB. This only surfaced for auto_send_enabled because other columns were already present in the affected app.db, so their checks didn’t trip the lock path. This change adds a safe rollback before DDL and a small retry wrapper with a busy timeout for migration ALTER TABLE statements. The behavior is unchanged when schemas are already up to date, but missing-column migrations now recover cleanly from transient locks and complete on startup.
- cwa | 
3b52dc30691c44e26ff153c3cfeaa3433f34f46d | 2026-01-30T00:03:15+01:00 | Fix intermittent “transaction is closed” when saving metadata | During edit/save (often after metadata fetch), we intermittently hit “This transaction is closed,” which is raised by SQLAlchemy as InvalidRequestError when the session’s transaction gets invalidated or closed mid-request. This left the edit flow failing and occasionally broke AJAX field updates. Addressed by: Catching InvalidRequestError during the main metadata save commit in do_edit_book, recreating the Calibre session, and retrying the commit once. Treating InvalidRequestError as a database error in the edit route and AJAX edit handler so the UI gets a consistent error message and rollback handling. [bug] Error editing book: This transaction is closed Fixes #947
- cwa | 
05d31d5f355a8056b2e813e1304852ac0bedcc46 | 2026-01-30T00:02:45+01:00 | Fix metadata save flakiness after Fetch Metadata | Problem: Applying fetched metadata only updates form fields via JS; if TinyMCE or the rating widget isn’t ready, JS throws and aborts, leaving fields unchanged. TinyMCE content can remain unsynced to the textarea on submit, so the server saves stale metadata. Symptoms: “Save” sometimes appears to work in the edit view but doesn’t persist until a second attempt. Solution: Guard metadata population against missing/late TinyMCE and rating widget instances. Fall back to directly setting the textarea when TinyMCE isn’t available. Trigger TinyMCE sync on form submit to ensure updated description is sent. Files: cps/static/js/get_meta.js: add safe checks and textarea fallback when applying fetched metadata. cps/static/js/edit_books.js: trigger TinyMCE save on submit. Impact: More reliable first‑try saves after metadata fetch. No server‑side logic changes; minimal, UI‑only behavior changes. [bug] Metadata update not saving Fixes #948
- cwa | 
e6b0c38cb5f7897474c24a557eab285198ba7c6b | 2026-01-29T23:56:43+01:00 | Update copyright years in all relevant files to 2026 for Calibre-Web contributors and Calibre-Web Automated contributors
- cwa | 
4a5774fead61dff16466cb34eae765873213c092 | 2026-01-29T23:53:37+01:00 | Harden app.db resolution and startup checks for auto-send migration issues | Fix mismatched app.db usage across services by resolving the settings DB from CWA_APP_DB_PATH or CALIBRE_DBPATH, and refuse non-app.db file paths. Align ingest pipeline and Calibre init helpers to the same app.db resolver to avoid stale/wrong DB usage (e.g., accidentally using cwa.db). Add clear error logging when the auto_send_enabled column migration fails so permission/lock/path issues surface instead of silently breaking startup. Introduce a lightweight app.db healthcheck at startup to flag missing, non-writable, or locked DBs early. Skip PRAGMA quick_check when NETWORK_SHARE_MODE=true to avoid network-share stalls or spurious lock errors.
- cwa | 
04b3540b6429a7df50ddb92d94a689d118067f1b | 2026-01-29T23:19:35+01:00 | Fix Hardcover review matches layout and actions | Prevent Isotope from initializing on non-book rows and guard layout calls to stop height: 0px and console errors. Move match action JS to the proper load block and ensure csrf_token is present so buttons work. Add cover fallbacks and normalize URLs, then allow https: images in CSP for the review page. Fix backend review action errors by using datetime.utcnow() and removing the local json shadowing, plus safer payload parsing.
- cwa | 
32156431df10b9028487c6413e39c364b986e6c2 | 2026-01-29T23:13:22+01:00 | Make EPUB fixer safer by default + add aggressive toggle | Fixes caused by unsafe UTF‑8 decoding and DOM reserialization that could corrupt EPUBs. Introduces encoding detection/preservation with UTF‑16 only honored when BOM/XML declares it, logs low‑confidence decodes, and writes text using per‑file target encodings. HTML charset updates now preserve existing http‑equiv tags, and safe mode removes stray `<img>` tags without full reserialization. Adds `kindle_epub_fixer_aggressive` (default off) to settings UI and schema so riskier transforms are opt‑in.
- cwa | 
c17695e0940332293c63b5420f96324c6578adf6 | 2026-01-29T22:30:09+01:00 | Fix: wrap homepage filter header in shelf box | Issue: On the homepage (/?data=root&sort_param=stored), the filter header floated without the dark container used on /rated/stored/. Fix: Use the same shelf-actions wrapper when the filter header is shown so it’s consistently encapsulated.
- cwa | 
9b2d59948c701eb1705d10a7c977f19ad44d609b | 2026-01-29T22:21:03+01:00 | Fix auto-zip by updating backup mtime | Backups used shutil.copy2, preserving original file timestamps. The auto-zipper only zips files with today’s mtime, so many backups were skipped. Switch to shutil.copy and reset mtime to now so daily zips include new backups. Fixes #260
- cwa | 
be6cb19cb33b8398d38886824d2a4d8c1d6ab828 | 2026-01-29T21:14:38+01:00 | Fix archived_book cleanup and add scheduled maintenance | Fix archived book count mismatch by deleting archived_book rows when a book is deleted. Add TaskCleanArchivedBooks to purge stale archived references safely in batches. Schedule cleanup via CWA settings (default 03:00 local) and expose schedule controls in CWA Settings UI. Add new cwa_settings defaults/schema fields for archived cleanup timing. [bug] Deleting An Archived Book Doesn't Remove Archived Book Entry From app.db's archived_book table Fixes #8243
- cwa | 
68895056271a3287b714704c8356215561034f66 | 2026-01-29T20:40:48+01:00 | Fix inflated book count in pagination | The homepage “Books (N)” total could be higher than the number of listed books when joins introduced duplicate rows. Use a distinct Books.id count for pagination totals so the displayed count matches the actual number of books. [bug] Number of books displayed is different than the number of books in my library Fixes #766
- cwa | 
59d4d334a3ed68d6a9df7ffecbfeb3abf8126d5f | 2026-01-29T20:34:31+01:00 | Bulk edit modal: clarify tags and multi-value input | Issue: The bulk edit dialog labeled tags as “Categories” and didn’t explain multi-value input, causing confusion about tag support and formatting. Resolution: Renamed the field to “Tags / Categories” and added a note explaining which fields accept multiple values and that they must be comma-separated.
- cwa | 
e3cea8cbaac1142a1d1b002184ddfaa9b36ed26b | 2026-01-29T20:21:39+01:00 | fix(fixer): repair duplicate XML declarations in container.xml | The Kindle EPUB fixer now detects and removes duplicate XML declarations in META-INF/container.xml, validating the result before writing. This normalizes malformed EPUBs during ingest to reduce reader failures and potential Send‑to‑Kindle E999 ingestion errors.
- cwa | 
92675e76b999b226ec5677d3414a16af9bd44f26 | 2026-01-29T20:21:22+01:00 | Fixed Web UI ereader not working with some books in new version. | fix(reader): handle invalid EPUB container.xml and prevent reader crashes Some EPUBs contain duplicate XML declarations in META-INF/container.xml, which makes epub.js fail to open the book and leaves the spinner running. The reader now guards against missing rendition state, shows a clear load error, and auto-repairs invalid container.xml when serving EPUBs. Also adds minimal styling for the error message and hardens progress tracking to avoid endless exceptions.
- cwa | 
8a889050abdedbbbab359b13d87b4dd13dd32c47 | 2026-01-29T20:06:57+01:00 | cwa: harden ingest flow, manifest handling, and stale temp cleanup | Problems: - Sidecar manifest files were being treated as ingest targets, causing premature deletion. - Ignored/temporary ingest artifacts could be deleted too early when readiness checks timed out. - Stale temp cleanup was hardcoded, not user-configurable, and required restarts to change behavior. Solutions: - Filtered manifest files in the ingest watcher and added processor guards to skip them. - Added skip-delete handling for ignored/temporary files on readiness timeout to preserve artifacts. Implemented robust stale temp cleanup with age and interval settings. - Persisted cleanup settings in the CWA database with sane defaults and validation. - Exposed new cleanup controls in the settings UI and made the ingest service read live values from the database instead of environment variables. Other changes: - Centralized integer parsing and defaulting logic for the new settings. - Added clear UI descriptions and bounds for the new cleanup options. - Improved observability with explicit log messages for skip-delete behavior and cleanup timing.
- cwa | 
97acd9db510386b538c90e924d221581cfea8e9a | 2026-01-29T19:24:22+01:00 | Fix styling issues on DB Config page
- cwa | 
a3c00f068b330e57d473bb7e3eab815117a88a32 | 2026-01-29T18:46:51+01:00 | Fix duplicate scan timezone comparisons | Issue: duplicate scan compared timezone-aware timestamp values against naive datetime.min/max, triggering “can't compare offset-naive and offset-aware datetimes.” Fix: normalize timestamps to UTC and use timezone-aware min/max defaults in duplicate selection and sorting; add a focused unit test covering mixed naive/aware timestamps. [bug] Fixes #945
- cwa | 
ac0a7e1e2548ce550182627d568ca63e3456fb89 | 2026-01-29T18:27:45+01:00 | fix(pubdate): prevent timezone day shift in published date display | pubdate is stored as a datetime, so Babel’s format_date could apply timezone offsets and render the prior day. Normalize datetime values to date in the formatdate/formatdateinput filters to display the correct day without affecting stored data. [bug] Published date in CWA is one day off Fixes #789
- cwa | 
2351012c0b7e672d4d2f24e2a8ea1a661a635d28 | 2026-01-29T18:25:34+01:00 | Fix DB config crash when calibre dir missing | Admin DB config updates could submit without config_calibre_dir, causing a KeyError when saving and breaking split-library setup. Default to the existing config when the field is absent, validate empty split paths, and log a warning for missing input to aid diagnostics. [bug] Can't separate book files from Library Fixes #870 [bug] unable to separate library from database, never could, and now I can't use CWA at all Fixes #779
- cwa | 
3a1af44d625ff9b906500315ba6a20b3ef419087 | 2026-01-29T18:16:17+01:00 | fix(cover-enforcer): avoid polling loop on failed logs | The metadata-change-detector polling watcher would re-process the same JSON log when calibredb/enforcement fails because the log was left in place. This change deletes failed logs and records a failure entry (“auto -log (failed)”) so the job is not retried indefinitely and admins can see failures in CWA stats. [bug] Subprocess error in cover enforcer results in infinite loop with polling watcher Fixes #829
- cwa | 
edb377070fba6052ef74dc9444f8352d73f7a6b2 | 2026-01-29T18:12:45+01:00 | Fix magic shelf negated tag filters | Negated operators on relationship fields (e.g., tags) used any(~condition), which still matched books with other tags and failed to exclude the target tag. Updated negated relationship operators to use ~any(condition) so books with matching tags are correctly excluded.
- cwa | 
b3c2230e3e9f426770e294d8e787f0891f8e8480 | 2026-01-29T18:00:57+01:00 | fix(stats): resolve Unknown user dropdown entries | Cause: stats dropdown used activity table user_name and stale user_ids, leaving many unmatched entries shown as “Unknown”. Fix: resolve names against app users by user_id, group all unmatched IDs under a single “Unknown User”, and allow list-based user filters in stats queries (with tests). [bug] Many unknown users in stats Fixes #942
- cwa | 
b2ac7edfeb15a4912a30c67472064dcb2c94974b | 2026-01-29T17:38:14+01:00 | Cause: CalibreDB.session was None on first request after the upgrade, so generate_linked_query() tried self.session.query(...) and crashed. That happens when the Calibre DB setup didn’t complete (or was briefly disposed) and no session was re-created before the request path. | Why this fixes it: ensure_session() now falls back to rebuilding the DB session from app.db if the normal config/session factory path is unavailable. That guarantees self.session exists before any queries run, preventing the NoneType error during startup/upgrade races [bug] AttributeError: 'NoneType' object has no attribute 'query' when updating to latest v4.0.0 docker Fixes #943
- cwa | 
7863a8fa04ee01bb98692421a90d1b80744afbf8 | 2026-01-29T17:17:30+01:00 | Finished reddit post for v4.0.0 release
