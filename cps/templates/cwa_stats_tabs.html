{% extends "layout.html" %}
{% block body %}

<script src="{{ url_for('static', filename='js/libs/echarts.min.js') }}"></script>

<style>
    .stats-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        border-bottom: 2px solid #3a4451;
        padding-bottom: 0;
    }
    
    .stats-tab {
        background: none;
        border: none;
        padding: 15px 30px;
        font-size: 1.1em;
        font-weight: 600;
        color: #aaa;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
        position: relative;
        bottom: -2px;
    }
    
    .stats-tab:hover {
        color: #ff9800;
        background: rgba(255, 152, 0, 0.05);
    }
    
    .stats-tab.active {
        color: #ff9800;
        border-bottom-color: #ff9800;
        background: rgba(255, 152, 0, 0.1);
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div class="discover" style="margin-top: 1rem !important;">
    <h2>{{title}}</h2>
    
    <!-- Tab Navigation -->
    <div class="stats-tabs">
        <button class="stats-tab {{ 'active' if active_tab == 'activity' else '' }}" 
                onclick="switchTab('activity')">
            üìä User Activity
        </button>
        <button class="stats-tab {{ 'active' if active_tab == 'library' else '' }}" 
                onclick="switchTab('library')">
            üìö Library Stats
        </button>
        <button class="stats-tab {{ 'active' if active_tab == 'api' else '' }}" 
                onclick="switchTab('api')">
            üì± API Usage
        </button>
        <button class="stats-tab {{ 'active' if active_tab == 'system' else '' }}" 
                onclick="switchTab('system')">
            ‚öôÔ∏è System Stats
        </button>
    </div>

    <div style="max-width: 1200px; margin: auto;">
        <!-- User Activity Tab -->
        <div id="activity-tab" class="tab-content {{ 'active' if active_tab == 'activity' else '' }}">
            {% include 'cwa_user_activity.html' %}
        </div>
        
        <!-- Library Stats Tab -->
        <div id="library-tab" class="tab-content {{ 'active' if active_tab == 'library' else '' }}">
            {% include 'cwa_library_stats.html' %}
        </div>
        
        <!-- API Usage Tab -->
        <div id="api-tab" class="tab-content {{ 'active' if active_tab == 'api' else '' }}">
            {% include 'cwa_api_stats.html' %}
        </div>
        
        <!-- System Logs Tab -->
        <div id="system-tab" class="tab-content {{ 'active' if active_tab == 'system' else '' }}">
            {% include 'cwa_stats_system.html' %}
        </div>
    </div>
    
</div>

<script>
function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.stats-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Update URL without page reload
    const url = new URL(window.location);
    url.searchParams.set('tab', tabName);
    window.history.pushState({}, '', url);
    
    // Resize charts after tab switch to fix layout issues
    setTimeout(() => {
        if (tabName === 'activity') {
            // Resize User Activity charts
            if (typeof timelineChart !== 'undefined' && timelineChart) timelineChart.resize();
            if (typeof eventsChart !== 'undefined' && eventsChart) eventsChart.resize();
            if (typeof formatsChart !== 'undefined' && formatsChart) formatsChart.resize();
            if (typeof heatmapChart !== 'undefined' && heatmapChart) heatmapChart.resize();
            if (typeof velocityChart !== 'undefined' && velocityChart) velocityChart.resize();
            if (typeof formatPreferencesChart !== 'undefined' && formatPreferencesChart) formatPreferencesChart.resize();
            if (typeof discoveryChart !== 'undefined' && discoveryChart) discoveryChart.resize();
            if (typeof deviceChart !== 'undefined' && deviceChart) deviceChart.resize();
            if (typeof sessionDurationChart !== 'undefined' && sessionDurationChart) sessionDurationChart.resize();
            if (typeof searchSuccessChart !== 'undefined' && searchSuccessChart) searchSuccessChart.resize();
        } else if (tabName === 'library') {
            // Resize Library Stats charts
            if (typeof growthChart !== 'undefined' && growthChart) growthChart.resize();
            if (typeof libraryFormatsChart !== 'undefined' && libraryFormatsChart) libraryFormatsChart.resize();
            if (typeof seriesChart !== 'undefined' && seriesChart) seriesChart.resize();
            if (typeof publicationYearChart !== 'undefined' && publicationYearChart) publicationYearChart.resize();
            if (typeof ratingStatsChart !== 'undefined' && ratingStatsChart) ratingStatsChart.resize();
            if (typeof topEnforcedChart !== 'undefined' && topEnforcedChart) topEnforcedChart.resize();
            if (typeof importSankeyChart !== 'undefined' && importSankeyChart) importSankeyChart.resize();
        } else if (tabName === 'api') {
            // Resize API Usage charts
            if (typeof apiUsageChart !== 'undefined' && apiUsageChart) apiUsageChart.resize();
            if (typeof apiTimingChart !== 'undefined' && apiTimingChart) apiTimingChart.resize();
        }
    }, 50); // Small delay to ensure DOM has updated
}
</script>

{% endblock %}
