<!-- User Activity Dashboard Content -->

<style>
    .stats-hero {
        background: linear-gradient(135deg, #2a3441 30%, #cc7b19 100%);
        padding: 40px 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        color: white;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        border: 1px solid #3a4451;
    }
    
    .stats-hero h1 {
        margin: 0 0 10px 0;
        font-size: 2.5em;
        font-weight: 700;
        text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    .stats-hero p {
        margin: 0;
        font-size: 1.1em;
        opacity: 0.85;
        color: #aaa;
    }
    
    .metrics-container {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .metric-card {
        background: #2a3441;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        border: 1px solid #3a4451;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 140px;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(255, 152, 0, 0.2);
        border-color: #ff9800;
    }
    
    .metric-value {
        font-size: 2.8em;
        font-weight: 700;
        margin: 10px 0;
        background: linear-gradient(135deg, #ff9800 0%, #ffc107 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .metric-label {
        font-size: 0.9em;
        color: #aaa;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
    }
    
    .metric-icon {
        font-size: 2em;
        opacity: 0.8;
        float: right;
        color: #ff9800;
    }
    
    .chart-container {
        background: #2a3441;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        border: 1px solid #3a4451;
    }
    
    .chart-title {
        font-size: 1.3em;
        font-weight: 600;
        margin-bottom: 20px;
        color: #fff;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #777;
        background: #2a3441;
        border-radius: 8px;
        border: 1px solid #3a4451;
    }
    
    .empty-state-icon {
        font-size: 4em;
        margin-bottom: 20px;
        opacity: 0.3;
        color: #ff9800;
    }
    
    .empty-state h3 {
        color: #ccc;
        margin-bottom: 10px;
    }
    
    .empty-state p {
        color: #888;
        margin-bottom: 30px;
    }
    
    .demo-toggle {
        background: linear-gradient(135deg, #ff9800 0%, #ff6f00 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 6px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
    }
    
    .demo-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 152, 0, 0.5);
        background: linear-gradient(135deg, #ffa726 0%, #ff8a00 100%);
    }
    
    .demo-toggle.active {
        background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
    }
    
    .demo-badge {
        display: inline-block;
        background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
        color: white;
        padding: 5px 15px;
        border-radius: 4px;
        font-size: 0.85em;
        margin-left: 10px;
        font-weight: 600;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }3a4451;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .top-item:last-child {
        border-bottom: none;
    }
    
    .top-item-name {
        font-weight: 500;
        color: #ddd;
        flex: 1;
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        align-items: center;
    }
    
    .top-item-value {
        font-weight: 700;
        color: #ff9800;
        font-size: 1.1em;
    }
    
    .search-term {
        background: #1a2332;
        padding: 10px 15px;
        margin-bottom: 8px;
        border-radius: 6px;
        border-left: 3px solid #ff9800;
        font-size: 0.95em;
        color: #ccc;
    }
    
    .search-term .timestamp {
        float: right;
        color: #7770.95em;
    }
    
    .search-term .timestamp {
        float: right;
        color: #999;
        font-size: 0.85em;
    }
    
    @media (max-width: 768px) {
        .stats-hero h1 {
            font-size: 1.8em;
        }
        .metric-value {
            font-size: 2em;
        }
        .metrics-container {
            flex-direction: column;
        }
    }

    div#top-users-list {
        width: -webkit-fill-available;
    }

    div.top-item {
        width: -webkit-fill-available;
        display: flex;
    }

    span.top-item-name > img.user-avatar {
        width: 1.5rem;
        margin: 0;
        margin-right: 1rem;
        border-radius: 50%;
        height: 1.5rem;
    }

    span.top-item-name > a {
        margin-left: 1rem;
    }

    .cwa-stats-row {
        height: auto !important;
    }

    .col-md-6 {
        padding-inline: 0px;
    }

    .col-md-4 {
        padding-inline: 0px;
    }

</style>

<!-- Hero Section -->
<div class="stats-hero">
    <h1>ğŸ“Š User Activity Dashboard</h1>
    <p>Track library usage, downloads, and user engagement</p>
</div>
    
    <!-- Demo Mode Toggle -->
    <div style="text-align: center; margin-bottom: 30px;" id="demo-toggle-container">
        <button class="demo-toggle" onclick="toggleDemoMode()" id="demo-button">
            ğŸ¨ Show Demo Data
        </button>
        <span class="demo-badge" id="demo-badge" style="display: none;">DEMO MODE</span>
    </div>
    
    <!-- Top Metrics Cards -->
    <div class="metrics-container" id="metrics-row">
        <div class="metric-card">
                <div class="metric-icon">ğŸ‘¥</div>
                <div class="metric-label">Active Users</div>
                <div class="metric-value" id="metric-users">{{ dashboard_stats.totals.active_users }}</div>
                <small style="color: #999;">Last 30 days</small>
        </div>
        <div class="metric-card">
            <div class="metric-icon">ğŸ“¥</div>
            <div class="metric-label">Total Downloads</div>
            <div class="metric-value" id="metric-downloads">{{ dashboard_stats.totals.total_downloads }}</div>
            <small style="color: #999;">Last 30 days</small>
        </div>
        <div class="metric-card">
            <div class="metric-icon">ğŸ“–</div>
            <div class="metric-label">Books Read</div>
            <div class="metric-value" id="metric-reads">{{ dashboard_stats.totals.total_reads }}</div>
            <small style="color: #999;">Last 30 days</small>
        </div>
        <div class="metric-card">
            <div class="metric-icon">ğŸ”</div>
            <div class="metric-label">Searches</div>
            <div class="metric-value" id="metric-searches">{{ dashboard_stats.totals.total_searches }}</div>
            <small style="color: #999;">Last 30 days</small>
        </div>
    </div>
    
    <!-- Activity Timeline Chart -->
    <div class="chart-container">
        <div class="chart-title">ğŸ“ˆ Activity Timeline</div>
        <div id="timeline-chart" style="width: 100%; height: 400px;"></div>
    </div>
    
    <!-- Second Row: Event Breakdown & Format Distribution -->
    <div class="row cwa-stats-row">
        <div class="col-md-6">
            <div class="chart-container">
                <div class="chart-title">ğŸ¯ Event Types</div>
                <div id="events-chart" style="width: 100%; height: 350px;"></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <div class="chart-title">ğŸ“¦ Download Formats</div>
                <div id="formats-chart" style="width: 100%; height: 350px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Third Row: Top Lists -->
    <div class="row">
        <div class="col-md-4">
            <div class="chart-container">
                <div class="chart-title">ğŸ† Top Users</div>
                <div id="top-users-list"></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container">
                <div class="chart-title">â­ Popular Books</div>
                <div id="top-books-list"></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container">
                <div class="chart-title">ğŸ” Recent Searches</div>
                <div id="recent-searches-list"></div>
            </div>
        </div>
    </div>
    
    <!-- Empty State (hidden by default) -->
    <div class="empty-state" id="empty-state" style="display: none;">
        <div class="empty-state-icon">ğŸ“Š</div>
        <h3>No Activity Data Yet</h3>
        <p>Start using your library to see beautiful visualizations and insights!</p>
        <p style="color: #bbb; font-size: 0.9em;">Downloads, reading sessions, and searches will be tracked here.</p>
    </div>

<script>
// Data from backend
const realData = {
    timeline: {{ dashboard_stats.timeline | tojson }},
    topUsers: {{ dashboard_stats.top_users | tojson }},
    topBooks: {{ dashboard_stats.top_books | tojson }},
    recentSearches: {{ dashboard_stats.recent_searches | tojson }},
    formatDistribution: {{ dashboard_stats.format_distribution | tojson }},
    eventBreakdown: {{ dashboard_stats.event_breakdown | tojson }},
    totals: {{ dashboard_stats.totals | tojson }}
};

// Check if we have real data
const hasRealData = realData.totals.total_events > 0;

// Demo data generator
function generateDemoData() {
    const dates = [];
    const today = new Date();
    for (let i = 29; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        dates.push(d.toISOString().split('T')[0]);
    }
    
    return {
        timeline: [
            ...dates.map(d => [d, 'DOWNLOAD', Math.floor(Math.random() * 25) + 5]),
            ...dates.map(d => [d, 'EMAIL', Math.floor(Math.random() * 30) + 10]),
            ...dates.map(d => [d, 'READ', Math.floor(Math.random() * 20) + 3]),
            ...dates.map(d => [d, 'SEARCH', Math.floor(Math.random() * 15) + 2]),
            ...dates.map(d => [d, 'LOGIN', Math.floor(Math.random() * 10) + 1])
        ],
        topUsers: [
            ['BookLover42', 156],
            ['ReadingFanatic', 134],
            ['LibraryMaster', 98],
            ['PageTurner', 87],
            ['BookwormPro', 76],
            ['NightReader', 65],
            ['StorySeeker', 54],
            ['NovelAddict', 43]
        ],
        topBooks: [
            ['The Midnight Library', 1234, 45],
            ['Project Hail Mary', 1235, 38],
            ['Dune', 1236, 32],
            ['1984', 1237, 28],
            ['The Hobbit', 1238, 24],
            ['Neuromancer', 1239, 21],
            ['Foundation', 1240, 18],
            ['Snow Crash', 1241, 15]
        ],
        recentSearches: [
            ['science fiction', '2025-12-29T10:23:45', 'BookLover42'],
            ['dystopian novels', '2025-12-29T09:15:22', 'ReadingFanatic'],
            ['classic literature', '2025-12-28T18:45:10', 'LibraryMaster'],
            ['fantasy series', '2025-12-28T16:30:55', 'PageTurner'],
            ['mystery thriller', '2025-12-28T14:20:33', 'BookwormPro'],
            ['historical fiction', '2025-12-27T22:10:18', 'NightReader'],
            ['biography', '2025-12-27T19:05:42', 'StorySeeker'],
            ['graphic novels', '2025-12-27T15:50:27', 'NovelAddict']
        ],
        formatDistribution: [
            ['EPUB', 245],
            ['PDF', 132],
            ['MOBI', 89],
            ['AZW3', 67],
            ['CBZ', 34]
        ],
        eventBreakdown: [
            ['EMAIL', 789],
            ['DOWNLOAD', 567],
            ['READ', 432],
            ['SEARCH', 234],
            ['LOGIN', 156]
        ],
        totals: {
            active_users: 24,
            total_downloads: 1356,
            total_reads: 432,
            total_searches: 234,
            total_events: 2178
        }
    };
}

let demoMode = false;
let currentData = hasRealData ? realData : generateDemoData();
let userProfiles = {};

// Initialize charts
let timelineChart, eventsChart, formatsChart;

function initCharts() {
    timelineChart = echarts.init(document.getElementById('timeline-chart'));
    eventsChart = echarts.init(document.getElementById('events-chart'));
    formatsChart = echarts.init(document.getElementById('formats-chart'));
    
    // Fetch user profiles first, then update visualizations
    fetch('/user_profiles.json')
        .then(response => response.json())
        .then(data => {
            userProfiles = data;
            updateAllVisualizations();
        })
        .catch(error => {
            console.log('Could not load user profiles, using default avatars');
            updateAllVisualizations();
        });
    
    // Responsive resize
    window.addEventListener('resize', () => {
        timelineChart.resize();
        eventsChart.resize();
        formatsChart.resize();
    });
}

function updateAllVisualizations() {
    updateMetrics();
    updateTimelineChart();
    updateEventsChart();
    updateFormatsChart();
    updateTopLists();
}

function updateMetrics() {
    document.getElementById('metric-users').textContent = currentData.totals.active_users;
    document.getElementById('metric-downloads').textContent = currentData.totals.total_downloads;
    document.getElementById('metric-reads').textContent = currentData.totals.total_reads;
    document.getElementById('metric-searches').textContent = currentData.totals.total_searches;
}

function updateTimelineChart() {
    const timelineData = currentData.timeline;
    
    // Group by date and event type
    const dateMap = {};
    timelineData.forEach(([date, event, count]) => {
        if (!dateMap[date]) dateMap[date] = {};
        dateMap[date][event] = count;
    });
    
    const dates = Object.keys(dateMap).sort();
    const eventTypes = [...new Set(timelineData.map(d => d[1]))];
    
    const series = eventTypes.map(event => ({
        name: event,
        type: 'line',
        smooth: true,
        data: dates.map(date => dateMap[date][event] || 0),
        areaStyle: {
            opacity: 0.3
        },
        emphasis: {
            focus: 'series'
        }
    }));
    
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            }
        },
        legend: {
            data: eventTypes,
            bottom: 0,
            textStyle: {
                color: '#fff'
            }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            top: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            boundaryGap: false,
            data: dates,
            axisLabel: {
                rotate: 45,
                color: '#fff',
                formatter: function(value) {
                    return value.split('-').slice(1).join('/');
                }
            },
            axisLine: {
                lineStyle: { color: '#3a4451' }
            }
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                color: '#fff'
            },
            axisLine: {
                lineStyle: { color: '#3a4451' }
            },
            splitLine: {
                lineStyle: { color: '#3a4451' }
            }
        },
        series: series,
        color: ['#ff9800', '#ffc107', '#4caf50', '#2196f3', '#9c27b0']
    };
    
    timelineChart.setOption(option, true);
}

function updateEventsChart() {
    const data = currentData.eventBreakdown.map(([name, value]) => ({
        name: name,
        value: value
    }));
    
    const option = {
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c} ({d}%)'
        },
        legend: {
            orient: 'vertical',
            left: 'left',
            textStyle: {
                color: '#fff'
            }
        },
        series: [{
            type: 'pie',
            radius: ['40%', '70%'],
            avoidLabelOverlap: false,
            itemStyle: {
                borderRadius: 10,
                borderColor: '#2a3441',
                borderWidth: 2
            },
            label: {
                show: true,
                formatter: '{b}: {d}%',
                color: '#fff'
            },
            emphasis: {
                label: {
                    show: true,
                    fontSize: 16,
                    fontWeight: 'bold'
                },
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            },
            data: data
        }],
        color: ['#ff9800', '#ffc107', '#4caf50', '#2196f3', '#9c27b0', '#00bcd4', '#8bc34a']
    };
    
    eventsChart.setOption(option, true);
}

function updateFormatsChart() {
    const data = currentData.formatDistribution;
    
    if (data.length === 0) {
        formatsChart.setOption({
            title: {
                text: 'No format data yet',
                left: 'center',
                top: 'center',
                textStyle: {
                    color: '#999',
                    fontSize: 14
                }
            }
        }, true);
        return;
    }
    
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            top: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'value',
            axisLabel: {
                color: '#fff'
            },
            axisLine: {
                lineStyle: { color: '#3a4451' }
            },
            splitLine: {
                lineStyle: { color: '#3a4451' }
            }
        },
        yAxis: {
            type: 'category',
            data: data.map(d => d[0]),
            axisLabel: {
                color: '#fff'
            },
            axisLine: {
                lineStyle: { color: '#3a4451' }
            }
        },
        series: [{
            type: 'bar',
            data: data.map(d => d[1]),
            itemStyle: {
                borderRadius: [0, 6, 6, 0],
                color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                    { offset: 0, color: '#ff9800' },
                    { offset: 1, color: '#ff6f00' }
                ])
            },
            emphasis: {
                itemStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                        { offset: 0, color: '#ffa726' },
                        { offset: 1, color: '#ff8a00' }
                    ])
                }
            }
        }]
    };
    
    formatsChart.setOption(option, true);
}

function updateTopLists() {
    // Top Users
    const usersHtml = currentData.topUsers.length > 0 
        ? currentData.topUsers.map(([name, count]) => {
            const profileImage = userProfiles[name];
            const avatar = profileImage 
                ? `<img src="${profileImage}" class="user-avatar" alt="${name}">` 
                : 'ğŸ‘¤';
            return `
                <div class="top-item">
                    <span class="top-item-name">${avatar} ${name}</span>
                    <span class="top-item-value">${count}</span>
                </div>
            `;
        }).join('')
        : '<p style="text-align: center; color: #999; padding: 20px;">No user activity yet</p>';
    document.getElementById('top-users-list').innerHTML = usersHtml;
    
    // Top Books
    const booksHtml = currentData.topBooks.length > 0
        ? currentData.topBooks.map(([title, id, count]) => `
            <div class="top-item">
                <span class="top-item-name">ğŸ“š <a href="/book/${id}">${title}</a></span>
                <span class="top-item-value">${count}</span>
            </div>
        `).join('')
        : '<p style="text-align: center; color: #999; padding: 20px;">No popular books yet</p>';
    document.getElementById('top-books-list').innerHTML = booksHtml;
    
    // Recent Searches
    const searchesHtml = currentData.recentSearches.length > 0
        ? currentData.recentSearches.map(([term, timestamp, user]) => `
            <div class="search-term">
                "${term}"
                <span class="timestamp">${timestamp.split('T')[0]}</span>
            </div>
        `).join('')
        : '<p style="text-align: center; color: #999; padding: 20px;">No searches yet</p>';
    document.getElementById('recent-searches-list').innerHTML = searchesHtml;
}

function toggleDemoMode() {
    demoMode = !demoMode;
    const button = document.getElementById('demo-button');
    const badge = document.getElementById('demo-badge');
    
    if (demoMode) {
        currentData = generateDemoData();
        button.textContent = 'ğŸ“Š Show Real Data';
        button.classList.add('active');
        badge.style.display = 'inline-block';
    } else {
        currentData = hasRealData ? realData : generateDemoData();
        button.textContent = 'ğŸ¨ Show Demo Data';
        button.classList.remove('active');
        badge.style.display = 'none';
    }
    
    updateAllVisualizations();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Show demo toggle only if no real data
    if (!hasRealData) {
        demoMode = true;
        document.getElementById('demo-badge').style.display = 'inline-block';
        document.getElementById('demo-button').textContent = 'ğŸ“Š Show Real Data (when available)';
        document.getElementById('demo-button').classList.add('active');
        document.getElementById('demo-button').disabled = true;
        document.getElementById('demo-button').style.opacity = '0.7';
        document.getElementById('demo-button').style.cursor = 'not-allowed';
    }
    
    initCharts();
});
</script>
