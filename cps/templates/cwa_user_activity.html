<!-- User Activity Dashboard Content -->

<style>
    .stats-hero {
        background: linear-gradient(135deg, #2a3441 30%, #cc7b19 100%);
        padding: 40px 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        color: white;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        border: 1px solid #3a4451;
    }
    
    .stats-hero h1 {
        margin: 0 0 10px 0;
        font-size: 2.5em;
        font-weight: 700;
        text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    .stats-hero p {
        margin: 0;
        font-size: 1.1em;
        opacity: 0.85;
        color: #aaa;
    }
    
    .metrics-container {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .metric-card {
        background: #2a3441;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        border: 1px solid #3a4451;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 140px;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(255, 152, 0, 0.2);
        border-color: #ff9800;
    }
    
    .metric-value {
        font-size: 2.8em;
        font-weight: 700;
        margin: 10px 0;
        background: linear-gradient(135deg, #ff9800 0%, #ffc107 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .metric-label {
        font-size: 0.9em;
        color: #aaa;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
    }
    
    .metric-icon {
        font-size: 2em;
        opacity: 0.8;
        float: right;
        color: #ff9800;
    }
    
    .chart-container {
        background: #2a3441;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        border: 1px solid #3a4451;
    }
    
    .chart-title {
        font-size: 1.3em;
        font-weight: 600;
        margin-bottom: 20px;
        color: #fff;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #777;
        background: #2a3441;
        border-radius: 8px;
        border: 1px solid #3a4451;
    }
    
    .empty-state-icon {
        font-size: 4em;
        margin-bottom: 20px;
        opacity: 0.3;
        color: #ff9800;
    }
    
    .empty-state h3 {
        color: #ccc;
        margin-bottom: 10px;
    }
    
    .empty-state p {
        color: #888;
        margin-bottom: 30px;
    }
    
    /* Loading Spinner */
    .chart-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        border: 4px solid #3a4451;
        border-top-color: #ff9800;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        z-index: 10;
    }
    
    .chart-loading-overlay {
        position: relative;
        min-height: 300px;
    }
    
    @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    .demo-toggle {
        background: linear-gradient(135deg, #ff9800 0%, #ff6f00 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 6px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
    }
    
    .demo-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 152, 0, 0.5);
        background: linear-gradient(135deg, #ffa726 0%, #ff8a00 100%);
    }
    
    .demo-toggle.active {
        background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
    }
    
    .demo-badge {
        display: inline-block;
        background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
        color: white;
        padding: 5px 15px;
        border-radius: 4px;
        font-size: 0.85em;
        margin-left: 10px;
        font-weight: 600;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }3a4451;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .top-item:last-child {
        border-bottom: none;
    }
    
    .top-item-name {
        font-weight: 500;
        color: #ddd;
        flex: 1;
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        align-items: center;
    }
    
    .top-item-value {
        font-weight: 700;
        color: #ff9800;
        font-size: 1.1em;
    }
    
    .search-term {
        background: #1a2332;
        padding: 10px 15px;
        margin-bottom: 8px;
        border-radius: 6px;
        border-left: 3px solid #ff9800;
        font-size: 0.95em;
        color: #ccc;
    }
    
    .search-term .timestamp {
        float: right;
        color: #7770.95em;
    }
    
    .search-term .timestamp {
        float: right;
        color: #999;
        font-size: 0.85em;
    }
    
    @media (max-width: 768px) {
        .stats-hero h1 {
            font-size: 1.8em;
        }
        .metric-value {
            font-size: 2em;
        }
        .metrics-container {
            flex-direction: column;
        }
    }

    div#top-users-list {
        width: -webkit-fill-available;
    }

    div.top-item {
        width: -webkit-fill-available;
        display: flex;
    }

    span.top-item-name > img.user-avatar {
        width: 1.5rem;
        margin: 0;
        margin-right: 1rem;
        border-radius: 50%;
        height: 1.5rem;
    }

    span.top-item-name > a {
        margin-left: 1rem;
    }

    .cwa-stats-row {
        height: auto !important;
    }

    .col-md-6 {
        padding-left: 10px;
        padding-right: 10px;
    }

    .col-md-4 {
        padding-left: 10px;
        padding-right: 10px;
    }

    .date-range-controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .date-range-picker {
        background: #2a3441;
        border: 1px solid #3a4451;
        border-radius: 8px;
        padding: 10px 20px;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .date-range-picker select,
    .date-range-picker input[type="date"] {
        background: #1a2332;
        color: #ddd;
        border: 1px solid #3a4451;
        border-radius: 4px;
        padding: 8px 12px;
        font-size: 0.95em;
        color-scheme: dark;
    }

    .date-range-picker select {
        cursor: pointer;
        min-width: 150px;
    }

    .date-range-picker input[type="date"] {
        min-width: 140px;
        cursor: pointer;
    }

    .date-range-picker input[type="date"]::-webkit-calendar-picker-indicator {
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23ff9800" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>') no-repeat center;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
    }

    .date-range-picker input[type="date"]::-webkit-calendar-picker-indicator:hover {
        opacity: 1;
    }

    .date-range-picker input[type="date"]:focus {
        outline: none;
        border-color: #ff9800;
        box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.2);
    }

    .date-range-picker select:focus {
        outline: none;
        border-color: #ff9800;
        box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.2);
    }

    .date-range-picker label {
        color: #aaa;
        font-size: 0.9em;
        margin: 0;
    }

    .date-warning {
        background: rgba(255, 152, 0, 0.1);
        border: 1px solid #ff9800;
        border-radius: 6px;
        padding: 8px 15px;
        color: #ffc107;
        font-size: 0.9em;
        display: none;
        margin-bottom: 3rem;
    }

</style>

<!-- Hero Section -->
<div class="stats-hero">
    <h1>ğŸ“Š User Activity Dashboard</h1>
    <p>Track library usage, downloads, and user engagement</p>
</div>
    
    <!-- Date Range & Demo Controls -->
    <div class="date-range-controls">
        <div class="date-range-picker">
            <label>ğŸ•µï¸ Filter by User:</label>
            <select id="user-filter" onchange="handleUserChange()">
                <option value="" {{ 'selected' if not selected_user_id else '' }}>All Users</option>
                {% for user_id, user_name in active_users %}
                <option value="{{ user_id }}" {{ 'selected' if selected_user_id == user_id else '' }}>{{ user_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="date-range-picker">
            <label>ğŸ“… Time Period:</label>
            <select id="date-preset" onchange="handlePresetChange()">
                <option value="7" {{ 'selected' if days == 7 else '' }}>Last 7 Days</option>
                <option value="30" {{ 'selected' if days == 30 or not days else '' }}>Last 30 Days</option>
                <option value="90" {{ 'selected' if days == 90 else '' }}>Last 90 Days</option>
                <option value="180" {{ 'selected' if days == 180 else '' }}>Last 6 Months</option>
                <option value="365" {{ 'selected' if days == 365 else '' }}>Last Year</option>
                <option value="custom" {{ 'selected' if start_date and end_date else '' }}>Custom Range</option>
            </select>
            <div id="custom-dates" style="display: {{ 'flex' if start_date and end_date else 'none' }}; gap: 10px; align-items: center;">
                <label>From:</label>
                <input type="date" id="start-date" value="{{ start_date or '' }}" onchange="handleCustomDateChange()">
                <label>To:</label>
                <input type="date" id="end-date" value="{{ end_date or '' }}" max="{{ today }}" onchange="handleCustomDateChange()">
            </div>
        </div>
        <button class="demo-toggle" onclick="resetDateRange()" id="reset-button">
            ğŸ”„ Reset
        </button>
        <button class="demo-toggle" onclick="exportActivityCSV()" style="margin-left: 10px; background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);">
            ğŸ“¥ Export CSV
        </button>
        <button class="demo-toggle" onclick="toggleDemoMode()" id="demo-button" style="margin-left: 10px;">
            ğŸ¨ Show Demo Data
        </button>
        <span class="demo-badge" id="demo-badge" style="display: none;">DEMO MODE</span>
    </div>
    <div class="date-warning" id="date-warning">
        âš ï¸ Large date ranges may take longer to load
    </div>
    
    <!-- Top Metrics Cards -->
    <div class="metrics-container" id="metrics-row">
        <div class="metric-card">
            {% if selected_user_id %}
                <div class="metric-icon">ğŸ”‘</div>
                <div class="metric-label">No of Logins</div>
                <div class="metric-value" id="metric-users">{{ dashboard_stats.totals.total_logins }}</div>
            {% else %}
                <div class="metric-icon">ğŸ‘¥</div>
                <div class="metric-label">Active Users</div>
                <div class="metric-value" id="metric-users">{{ dashboard_stats.totals.active_users }}</div>
            {% endif %}
                <small style="color: #999;" class="date-range-label">{{ date_range_label }}</small>
        </div>
        <div class="metric-card">
            <div class="metric-icon">ğŸ“¥</div>
            <div class="metric-label">Total Downloads</div>
            <div class="metric-value" id="metric-downloads">{{ dashboard_stats.totals.total_downloads }}</div>
            <small style="color: #999;" class="date-range-label">{{ date_range_label }}</small>
        </div>
        <div class="metric-card">
            <div class="metric-icon">ğŸ“–</div>
            <div class="metric-label">Books Read</div>
            <div class="metric-value" id="metric-reads">{{ dashboard_stats.totals.total_reads }}</div>
            <small style="color: #999;" class="date-range-label">{{ date_range_label }}</small>
        </div>
        <div class="metric-card">
            <div class="metric-icon">ğŸ”</div>
            <div class="metric-label">Searches</div>
            <div class="metric-value" id="metric-searches">{{ dashboard_stats.totals.total_searches }}</div>
            <small style="color: #999;" class="date-range-label">{{ date_range_label }}</small>
        </div>
    </div>
    
    <!-- Activity Timeline Chart -->
    <div class="chart-container">
        <div class="chart-title">ğŸ“ˆ Activity Timeline</div>
        <div id="timeline-chart" style="width: 100%; height: 400px;"></div>
    </div>
    
    <!-- Peak Usage Hours Heatmap -->
    <div class="chart-container">
        <div class="chart-title">ğŸ”¥ Peak Usage Hours</div>
        <div id="heatmap-chart" style="width: 100%; height: 350px;"></div>
    </div>
    
    <!-- Reading Velocity Trend -->
    <div class="chart-container">
        <div class="chart-title">ğŸ“š Reading Velocity (Books per Week)</div>
        <div id="velocity-chart" style="width: 100%; height: 350px;"></div>
    </div>
    
    <!-- Second Row: Event Breakdown & Format Distribution -->
    <div class="row cwa-stats-row">
        <div class="col-md-6">
            <div class="chart-container">
                <div class="chart-title">ğŸ¯ Event Types</div>
                <div id="events-chart" style="width: 100%; height: 350px;"></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <div class="chart-title">ğŸ“Š Format Preferences by User</div>
                <div id="format-preferences-chart" style="width: 100%; height: 350px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Third Row: Download Formats Pie Chart -->
    <div class="row cwa-stats-row">
        <div class="col-md-12">
            <div class="chart-container">
                <div class="chart-title">ğŸ“¦ Download Formats Distribution</div>
                <div id="formats-chart" style="width: 100%; height: 350px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Fourth Row: Discovery Sources, Device Breakdown, Security -->
    <div class="row cwa-stats-row">
        <div class="col-md-4">
            <div class="chart-container">
                <div class="chart-title">ğŸ“ Discovery Sources</div>
                <div id="discovery-chart" style="width: 100%; height: 350px;"></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container">
                <div class="chart-title">ğŸ“± Device Breakdown</div>
                <div id="device-chart" style="width: 100%; height: 350px;"></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container">
                <div class="chart-title">ğŸ”’ Security</div>
                <div class="metric-card" style="margin-bottom: 15px;">
                    <div class="metric-icon">ğŸ›¡ï¸</div>
                    <div class="metric-label">Failed Login Attempts</div>
                    <div class="metric-value" id="failed-logins-count">0</div>
                </div>
                <div id="failed-logins-list" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
    
    <!-- Fifth Row: Top Lists -->
    <div class="row cwa-stats-row">
        <div class="col-md-4">
            <div class="chart-container">
                {% if selected_user_id %}
                <div class="chart-title">ğŸ“… Most Active Days</div>
                <div id="most-active-days-list"></div>
                {% else %}
                <div class="chart-title">ğŸ† Top Users</div>
                <div id="top-users-list"></div>
                {% endif %}
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container">
                <div class="chart-title">â­ Popular Books</div>
                <div id="top-books-list"></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container">
                <div class="chart-title">ğŸ” Recent Searches</div>
                <div id="recent-searches-list"></div>
            </div>
        </div>
    </div>
    
    <!-- Sprint 5: Enhanced User Activity Metrics -->
    <div class="row cwa-stats-row">
        <div class="col-md-4">
            <div class="chart-container" style="min-height: 520px;">
                <div class="chart-title">â±ï¸ Average Session Duration</div>
                <div class="metric-card" style="margin-bottom: 15px;">
                    <div class="metric-icon">â°</div>
                    <div class="metric-label">Avg Session Length</div>
                    <div class="metric-value" id="avg-session-duration">0 min</div>
                </div>
                <div id="session-duration-chart" style="width: 100%; height: 250px;"></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container" style="min-height: 520px;">
                <div class="chart-title">ğŸ¯ Search Success Rate</div>
                <div class="metric-card" style="margin-bottom: 15px;">
                    <div class="metric-icon">ğŸ”</div>
                    <div class="metric-label">Searches Leading to Actions</div>
                    <div class="metric-value" id="search-success-rate">0%</div>
                    <div style="font-size: 0.9em; color: #aaa; margin-top: 5px;">
                        <span id="search-success-count">0</span> of <span id="total-searches">0</span> searches
                    </div>
                </div>
                <div id="search-success-chart" style="width: 100%; height: 250px;"></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container" style="min-height: 520px;">
                <div class="chart-title">ğŸ“š Shelf Activity</div>
                <div id="shelf-activity-list" style="max-height: 420px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
    
    <!-- Empty State (hidden by default) -->
    <div class="empty-state" id="empty-state" style="display: none;">
        <div class="empty-state-icon">ğŸ“Š</div>
        <h3>No Activity Data Yet</h3>
        <p>Start using your library to see beautiful visualizations and insights!</p>
        <p style="color: #bbb; font-size: 0.9em;">Downloads, reading sessions, and searches will be tracked here.</p>
    </div>

<script>
// Data from backend
const realData = {
    timeline: {{ dashboard_stats.timeline | tojson }},
    topUsers: {{ dashboard_stats.top_users | tojson }},
    topBooks: {{ dashboard_stats.top_books | tojson }},
    recentSearches: {{ dashboard_stats.recent_searches | tojson }},
    formatDistribution: {{ dashboard_stats.format_distribution | tojson }},
    eventBreakdown: {{ dashboard_stats.event_breakdown | tojson }},
    totals: {{ dashboard_stats.totals | tojson }},
    heatmap: {{ hourly_heatmap | tojson }},
    velocity: {{ reading_velocity | tojson }},
    formatPreferences: {{ format_preferences | tojson }},
    discoverySources: {{ discovery_sources | tojson }},
    deviceBreakdown: {{ device_breakdown | tojson }},
    failedLogins: {{ failed_logins | tojson }},
    sessionDuration: {{ session_duration | tojson }},
    searchSuccess: {{ search_success | tojson }},
    shelfActivity: {{ shelf_activity | tojson }}
};

const isAdmin = {{ 'true' if is_admin else 'false' }};

// Check if we have real data
const hasRealData = realData.totals.total_events > 0;

// Demo data generator
function generateDemoData() {
    // Get date range from URL parameters or use 30 days default
    const urlParams = new URLSearchParams(window.location.search);
    const days = parseInt(urlParams.get('days')) || 30;
    const startDate = urlParams.get('start_date');
    const endDate = urlParams.get('end_date');
    
    let numDays = days;
    let endDateObj = new Date();
    
    if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        numDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
        endDateObj = end;
    }
    
    const dates = [];
    for (let i = numDays - 1; i >= 0; i--) {
        const d = new Date(endDateObj);
        d.setDate(d.getDate() - i);
        dates.push(d.toISOString().split('T')[0]);
    }
    
    // Scale demo data based on range
    const scaleFactor = Math.min(1, 30 / numDays);
    
    // Check if we're in single user mode
    const selectedUserId = urlParams.get('user_id');
    
    // Generate appropriate topUsers data based on mode
    let topUsersData;
    if (selectedUserId) {
        // Generate Most Active Days data (date, count pairs)
        // Sample some random days from the range with varying activity counts
        const sampleSize = Math.min(8, numDays);
        const sampledDates = [];
        for (let i = 0; i < sampleSize; i++) {
            const randomIdx = Math.floor(Math.random() * dates.length);
            sampledDates.push(dates[randomIdx]);
        }
        
        topUsersData = [...new Set(sampledDates)].slice(0, 8).map(date => [
            date,
            Math.floor(Math.random() * 40 + 10) // Random activity count 10-50
        ]).sort((a, b) => b[1] - a[1]); // Sort by count descending
    } else {
        // Generate normal Top Users data (user_id, name, count)
        topUsersData = [
            [1, 'BookLover42', 156],
            [2, 'ReadingFanatic', 134],
            [3, 'LibraryMaster', 98],
            [4, 'PageTurner', 87],
            [5, 'BookwormPro', 76],
            [6, 'NightReader', 65],
            [7, 'StorySeeker', 54],
            [8, 'NovelAddict', 43]
        ];
    }
    
    return {
        timeline: [
            ...dates.map(d => [d, 'DOWNLOAD', Math.floor((Math.random() * 25 + 5) * scaleFactor)]),
            ...dates.map(d => [d, 'EMAIL', Math.floor((Math.random() * 30 + 10) * scaleFactor)]),
            ...dates.map(d => [d, 'READ', Math.floor((Math.random() * 20 + 3) * scaleFactor)]),
            ...dates.map(d => [d, 'SEARCH', Math.floor((Math.random() * 15 + 2) * scaleFactor)]),
            ...dates.map(d => [d, 'LOGIN', Math.floor((Math.random() * 10 + 1) * scaleFactor)])
        ],
        topUsers: topUsersData,
        topBooks: [
            ['The Midnight Library', 1234, 45],
            ['Project Hail Mary', 1235, 38],
            ['Dune', 1236, 32],
            ['1984', 1237, 28],
            ['The Hobbit', 1238, 24],
            ['Neuromancer', 1239, 21],
            ['Foundation', 1240, 18],
            ['Snow Crash', 1241, 15]
        ],
        recentSearches: [
            ['science fiction', '2025-12-29T10:23:45', 'BookLover42'],
            ['dystopian novels', '2025-12-29T09:15:22', 'ReadingFanatic'],
            ['classic literature', '2025-12-28T18:45:10', 'LibraryMaster'],
            ['fantasy series', '2025-12-28T16:30:55', 'PageTurner'],
            ['mystery thriller', '2025-12-28T14:20:33', 'BookwormPro'],
            ['historical fiction', '2025-12-27T22:10:18', 'NightReader'],
            ['biography', '2025-12-27T19:05:42', 'StorySeeker'],
            ['graphic novels', '2025-12-27T15:50:27', 'NovelAddict']
        ],
        formatDistribution: [
            ['EPUB', 245],
            ['PDF', 132],
            ['MOBI', 89],
            ['AZW3', 67],
            ['CBZ', 34]
        ],
        eventBreakdown: [
            ['EMAIL', 789],
            ['DOWNLOAD', 567],
            ['READ', 432],
            ['SEARCH', 234],
            ['LOGIN', 156]
        ],
        totals: selectedUserId ? {
            // Single user mode: show total_logins instead of active_users
            active_users: 0,
            total_logins: 47,
            total_downloads: 1356,
            total_reads: 432,
            total_searches: 234,
            total_events: 2178
        } : {
            // All users mode: show active_users
            active_users: 24,
            total_downloads: 1356,
            total_reads: 432,
            total_searches: 234,
            total_events: 2178
        },
        // Generate heatmap data (day of week, hour, count)
        heatmap: (() => {
            const heatmapData = [];
            for (let day = 0; day < 7; day++) {
                for (let hour = 0; hour < 24; hour++) {
                    // Peak hours: 6-9am, 12-2pm, 6-11pm with variation by day
                    let baseCount = 5;
                    if ((hour >= 6 && hour <= 9) || (hour >= 12 && hour <= 14) || (hour >= 18 && hour <= 23)) {
                        baseCount = 15 + Math.floor(Math.random() * 20);
                    } else if (hour >= 1 && hour <= 5) {
                        baseCount = Math.floor(Math.random() * 3);
                    } else {
                        baseCount = 5 + Math.floor(Math.random() * 10);
                    }
                    // Weekend boost
                    if (day === 0 || day === 6) {
                        baseCount = Math.floor(baseCount * 1.3);
                    }
                    heatmapData.push([day, hour, baseCount]);
                }
            }
            return heatmapData;
        })(),
        // Generate velocity data (week start date, books read)
        velocity: (() => {
            const velocityData = [];
            const weeksBack = Math.ceil(numDays / 7);
            for (let i = weeksBack - 1; i >= 0; i--) {
                const weekDate = new Date(endDateObj);
                weekDate.setDate(weekDate.getDate() - (i * 7));
                const weekStr = weekDate.toISOString().split('T')[0];
                const booksRead = 3 + Math.floor(Math.random() * 12); // 3-15 books per week
                velocityData.push([weekStr, booksRead]);
            }
            return velocityData;
        })(),
        // Generate format preferences (user, format, count)
        formatPreferences: selectedUserId ? [] : (() => {
            const users = ['BookLover42', 'ReadingFanatic', 'LibraryMaster', 'PageTurner', 'BookwormPro', 'NightReader', 'StorySeeker', 'NovelAddict'];
            const formats = ['EPUB', 'PDF', 'MOBI', 'AZW3', 'KEPUB'];
            const prefs = [];
            users.slice(0, 8).forEach(user => {
                // Each user has preference distribution
                const userTotal = 50 + Math.floor(Math.random() * 100);
                let remaining = userTotal;
                formats.forEach((format, idx) => {
                    if (idx === formats.length - 1) {
                        if (remaining > 0) prefs.push([user, format, remaining]);
                    } else {
                        const count = Math.floor(Math.random() * (remaining * 0.5));
                        if (count > 0) prefs.push([user, format, count]);
                        remaining -= count;
                    }
                });
            });
            return prefs;
        })(),
        // Generate discovery sources (source, count)
        discoverySources: [
            ['search', 234 + Math.floor(Math.random() * 50)],
            ['book_detail', 189 + Math.floor(Math.random() * 40)],
            ['series', 156 + Math.floor(Math.random() * 30)],
            ['author', 98 + Math.floor(Math.random() * 25)],
            ['browse', 67 + Math.floor(Math.random() * 20)],
            ['shelf', 45 + Math.floor(Math.random() * 15)],
            ['direct', 23 + Math.floor(Math.random() * 10)]
        ],
        // Generate device breakdown (device_type, count)
        deviceBreakdown: [
            ['desktop', 456 + Math.floor(Math.random() * 100)],
            ['mobile', 289 + Math.floor(Math.random() * 80)],
            ['tablet', 134 + Math.floor(Math.random() * 40)]
        ],
        // Generate failed logins (ip, username, timestamp, count)
        failedLogins: Math.random() > 0.7 ? [
            ['192.168.1.123', 'admin', new Date().toISOString(), Math.floor(Math.random() * 5) + 1],
            ['10.0.0.45', 'testuser', new Date().toISOString(), Math.floor(Math.random() * 3) + 1]
        ] : [],
        // Generate session duration stats
        sessionDuration: {
            average_minutes: 15 + Math.floor(Math.random() * 30), // 15-45 minutes
            distribution: (() => {
                const dist = [];
                for (let i = 0; i < 60; i += 5) {
                    const count = Math.max(0, Math.floor(Math.random() * 20) - (i / 10));
                    if (count > 0) dist.push([i, count]);
                }
                return dist;
            })()
        },
        // Generate search success rate
        searchSuccess: {
            total_searches: 150 + Math.floor(Math.random() * 100),
            successful_searches: 100 + Math.floor(Math.random() * 80),
            success_rate: 55 + Math.floor(Math.random() * 30), // 55-85%
            trend: Math.floor(Math.random() * 20) - 5 // -5 to +15
        },
        // Generate shelf activity (shelf_name, add_count, remove_count, net_change)
        shelfActivity: [
            ['To Read', 45, 12, 33],
            ['Currently Reading', 28, 15, 13],
            ['Favorites', 23, 3, 20],
            ['Completed', 67, 5, 62],
            ['Science Fiction', 19, 8, 11],
            ['Fantasy', 15, 6, 9],
            ['Non-Fiction', 12, 4, 8],
            ['Mystery', 9, 2, 7],
            ['Romance', 8, 3, 5],
            ['Wishlist', 6, 1, 5]
        ].map(([name, add, remove, net]) => [
            name,
            add + Math.floor(Math.random() * 10),
            remove + Math.floor(Math.random() * 5),
            net + Math.floor(Math.random() * 8)
        ])
    };
}

let demoMode = false;
let currentData = realData;  // Always start with real data, even if empty
let userProfiles = {};

// Initialize charts
let timelineChart, eventsChart, formatsChart, heatmapChart, velocityChart, formatPreferencesChart, discoveryChart, deviceChart, sessionDurationChart, searchSuccessChart;

function initCharts() {
    timelineChart = echarts.init(document.getElementById('timeline-chart'));
    eventsChart = echarts.init(document.getElementById('events-chart'));
    formatsChart = echarts.init(document.getElementById('formats-chart'));
    heatmapChart = echarts.init(document.getElementById('heatmap-chart'));
    velocityChart = echarts.init(document.getElementById('velocity-chart'));
    formatPreferencesChart = echarts.init(document.getElementById('format-preferences-chart'));
    discoveryChart = echarts.init(document.getElementById('discovery-chart'));
    deviceChart = echarts.init(document.getElementById('device-chart'));
    sessionDurationChart = echarts.init(document.getElementById('session-duration-chart'));
    searchSuccessChart = echarts.init(document.getElementById('search-success-chart'));
    
    // Fetch user profiles first, then update visualizations
    fetch('/user_profiles.json')
        .then(response => response.json())
        .then(data => {
            userProfiles = data;
            updateAllVisualizations();
        })
        .catch(error => {
            console.log('Could not load user profiles, using default avatars');
            updateAllVisualizations();
        });
    
    // Responsive resize
    window.addEventListener('resize', () => {
        timelineChart.resize();
        eventsChart.resize();
        formatsChart.resize();
        heatmapChart.resize();
        velocityChart.resize();
        formatPreferencesChart.resize();
        discoveryChart.resize();
        deviceChart.resize();
        sessionDurationChart.resize();
        searchSuccessChart.resize();
    });
}

function updateAllVisualizations() {
    updateMetrics();
    updateTimelineChart();
    updateHeatmapChart();
    updateVelocityChart();
    updateEventsChart();
    updateFormatPreferencesChart();
    updateFormatsChart();
    updateDiscoveryChart();
    updateDeviceChart();
    updateFailedLogins();
    updateTopLists();
    updateSessionDuration();
    updateSearchSuccess();
    updateShelfActivity();
}

function updateMetrics() {
    // Check if we're in single user mode
    const urlParams = new URLSearchParams(window.location.search);
    const selectedUserId = urlParams.get('user_id');
    
    if (selectedUserId) {
        // Show total logins for single user
        document.getElementById('metric-users').textContent = currentData.totals.total_logins || 0;
    } else {
        // Show active users for all users
        document.getElementById('metric-users').textContent = currentData.totals.active_users || 0;
    }
    
    document.getElementById('metric-downloads').textContent = currentData.totals.total_downloads;
    document.getElementById('metric-reads').textContent = currentData.totals.total_reads;
    document.getElementById('metric-searches').textContent = currentData.totals.total_searches;
}

function updateTimelineChart() {
    const timelineData = currentData.timeline;
    
    // Group by date and event type
    const dateMap = {};
    timelineData.forEach(([date, event, count]) => {
        if (!dateMap[date]) dateMap[date] = {};
        dateMap[date][event] = count;
    });
    
    const dates = Object.keys(dateMap).sort();
    const eventTypes = [...new Set(timelineData.map(d => d[1]))];
    
    const series = eventTypes.map(event => ({
        name: event,
        type: 'line',
        smooth: true,
        data: dates.map(date => dateMap[date][event] || 0),
        areaStyle: {
            opacity: 0.3
        },
        emphasis: {
            focus: 'series'
        }
    }));
    
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            }
        },
        legend: {
            data: eventTypes,
            bottom: 0,
            textStyle: {
                color: '#fff'
            }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            top: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            boundaryGap: false,
            data: dates,
            axisLabel: {
                rotate: 45,
                color: '#fff',
                formatter: function(value) {
                    return value.split('-').slice(1).join('/');
                }
            },
            axisLine: {
                lineStyle: { color: '#3a4451' }
            }
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                color: '#fff'
            },
            axisLine: {
                lineStyle: { color: '#3a4451' }
            },
            splitLine: {
                lineStyle: { color: '#3a4451' }
            }
        },
        series: series,
        color: ['#ff9800', '#ffc107', '#4caf50', '#2196f3', '#9c27b0']
    };
    
    timelineChart.setOption(option, true);
}

function updateEventsChart() {
    const data = currentData.eventBreakdown.map(([name, value]) => ({
        name: name,
        value: value
    }));
    
    const option = {
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c} ({d}%)'
        },
        legend: {
            orient: 'vertical',
            left: 'left',
            textStyle: {
                color: '#fff'
            }
        },
        series: [{
            type: 'pie',
            radius: ['40%', '70%'],
            avoidLabelOverlap: false,
            itemStyle: {
                borderRadius: 10,
                borderColor: '#2a3441',
                borderWidth: 2
            },
            label: {
                show: true,
                formatter: '{b}: {d}%',
                color: '#fff'
            },
            emphasis: {
                label: {
                    show: true,
                    fontSize: 16,
                    fontWeight: 'bold'
                },
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            },
            data: data
        }],
        color: ['#ff9800', '#ffc107', '#4caf50', '#2196f3', '#9c27b0', '#00bcd4', '#8bc34a']
    };
    
    eventsChart.setOption(option, true);
}

function updateFormatsChart() {
    const data = currentData.formatDistribution;
    
    if (data.length === 0) {
        formatsChart.setOption({
            title: {
                text: 'No format data yet',
                left: 'center',
                top: 'center',
                textStyle: {
                    color: '#999',
                    fontSize: 14
                }
            }
        }, true);
        return;
    }
    
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            top: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'value',
            axisLabel: {
                color: '#fff'
            },
            axisLine: {
                lineStyle: { color: '#3a4451' }
            },
            splitLine: {
                lineStyle: { color: '#3a4451' }
            }
        },
        yAxis: {
            type: 'category',
            data: data.map(d => d[0]),
            axisLabel: {
                color: '#fff'
            },
            axisLine: {
                lineStyle: { color: '#3a4451' }
            }
        },
        series: [{
            type: 'bar',
            data: data.map(d => d[1]),
            itemStyle: {
                borderRadius: [0, 6, 6, 0],
                color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                    { offset: 0, color: '#ff9800' },
                    { offset: 1, color: '#ff6f00' }
                ])
            },
            emphasis: {
                itemStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                        { offset: 0, color: '#ffa726' },
                        { offset: 1, color: '#ff8a00' }
                    ])
                }
            }
        }]
    };
    
    formatsChart.setOption(option, true);
}

function updateHeatmapChart() {
    const data = currentData.heatmap || [];
    
    if (data.length === 0) {
        heatmapChart.setOption({
            title: {
                text: 'No activity data yet',
                left: 'center',
                top: 'center',
                textStyle: {
                    color: '#999',
                    fontSize: 14
                }
            }
        }, true);
        return;
    }
    
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const hours = Array.from({length: 24}, (_, i) => i + ':00');
    
    // Transform data to [hour, day, value] format
    const heatmapData = data.map(([day, hour, count]) => [hour, day, count]);
    
    const option = {
        tooltip: {
            position: 'top',
            formatter: (params) => {
                const hour = params.data[0];
                const day = days[params.data[1]];
                const count = params.data[2];
                return `${day} ${hour}:00<br/>Activity: ${count}`;
            }
        },
        grid: {
            height: '70%',
            top: '10%',
            left: '10%',
            right: '5%'
        },
        xAxis: {
            type: 'category',
            data: hours,
            splitArea: {
                show: true
            },
            axisLabel: {
                color: '#fff',
                interval: 2
            },
            axisLine: {
                lineStyle: { color: '#3a4451' }
            }
        },
        yAxis: {
            type: 'category',
            data: days,
            splitArea: {
                show: true
            },
            axisLabel: {
                color: '#fff'
            },
            axisLine: {
                lineStyle: { color: '#3a4451' }
            }
        },
        visualMap: {
            min: 0,
            max: Math.max(...data.map(d => d[2])) || 1,
            calculable: true,
            orient: 'horizontal',
            left: 'center',
            bottom: '5%',
            inRange: {
                color: ['#1a2332', '#2a3441', '#ff6f00', '#ff9800', '#ffa726']
            },
            textStyle: {
                color: '#fff'
            }
        },
        series: [{
            name: 'Activity',
            type: 'heatmap',
            data: heatmapData,
            label: {
                show: false
            },
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowColor: 'rgba(255, 152, 0, 0.5)'
                }
            }
        }]
    };
    
    heatmapChart.setOption(option, true);
}

function updateVelocityChart() {
    const data = currentData.velocity || [];
    
    if (data.length === 0) {
        velocityChart.setOption({
            title: {
                text: 'No reading data yet',
                left: 'center',
                top: 'center',
                textStyle: {
                    color: '#999',
                    fontSize: 14
                }
            }
        }, true);
        return;
    }
    
    // Calculate 4-week moving average
    const movingAvg = [];
    const windowSize = 4;
    for (let i = 0; i < data.length; i++) {
        const start = Math.max(0, i - windowSize + 1);
        const window = data.slice(start, i + 1);
        const avg = window.reduce((sum, d) => sum + d[1], 0) / window.length;
        movingAvg.push(avg.toFixed(1));
    }
    
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            }
        },
        legend: {
            data: ['Books Read', '4-Week Avg'],
            textStyle: {
                color: '#fff'
            },
            top: '5%'
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            top: '15%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: data.map(d => d[0]),
            axisLabel: {
                color: '#fff',
                rotate: 45
            },
            axisLine: {
                lineStyle: { color: '#3a4451' }
            }
        },
        yAxis: {
            type: 'value',
            name: 'Books',
            nameTextStyle: {
                color: '#fff'
            },
            axisLabel: {
                color: '#fff'
            },
            axisLine: {
                lineStyle: { color: '#3a4451' }
            },
            splitLine: {
                lineStyle: { color: '#3a4451' }
            }
        },
        series: [
            {
                name: 'Books Read',
                type: 'bar',
                data: data.map(d => d[1]),
                itemStyle: {
                    color: new echarts.graphic.LinearGradient(0, 1, 0, 0, [
                        { offset: 0, color: '#ff6f00' },
                        { offset: 1, color: '#ff9800' }
                    ]),
                    borderRadius: [6, 6, 0, 0]
                }
            },
            {
                name: '4-Week Avg',
                type: 'line',
                data: movingAvg,
                smooth: true,
                lineStyle: {
                    color: '#2196f3',
                    width: 3
                },
                itemStyle: {
                    color: '#2196f3'
                }
            }
        ]
    };
    
    velocityChart.setOption(option, true);
}

function updateFormatPreferencesChart() {
    const data = currentData.formatPreferences || [];
    
    if (data.length === 0) {
        formatPreferencesChart.setOption({
            title: {
                text: 'No format preference data yet',
                left: 'center',
                top: 'center',
                textStyle: {
                    color: '#999',
                    fontSize: 14
                }
            }
        }, true);
        return;
    }
    
    // Group data by user
    const userMap = {};
    data.forEach(([user, format, count]) => {
        if (!userMap[user]) userMap[user] = {};
        userMap[user][format] = count;
    });
    
    const users = Object.keys(userMap).slice(0, 10); // Top 10 users
    const formats = [...new Set(data.map(d => d[1]))];
    
    // Define format colors
    const formatColors = {
        'EPUB': '#ff9800',
        'PDF': '#2196f3',
        'MOBI': '#4caf50',
        'AZW3': '#9c27b0',
        'KEPUB': '#f44336',
        'TXT': '#795548',
        'CBZ': '#00bcd4',
        'CBR': '#ff5722',
        'UNKNOWN': '#999'
    };
    
    const series = formats.map(format => ({
        name: format,
        type: 'bar',
        stack: 'total',
        data: users.map(user => userMap[user][format] || 0),
        itemStyle: {
            color: formatColors[format] || '#999'
        },
        emphasis: {
            focus: 'series'
        }
    }));
    
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            }
        },
        legend: {
            data: formats,
            textStyle: {
                color: '#fff'
            },
            top: '5%'
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            top: '15%',
            containLabel: true
        },
        xAxis: {
            type: 'value',
            axisLabel: {
                color: '#fff'
            },
            axisLine: {
                lineStyle: { color: '#3a4451' }
            },
            splitLine: {
                lineStyle: { color: '#3a4451' }
            }
        },
        yAxis: {
            type: 'category',
            data: users,
            axisLabel: {
                color: '#fff'
            },
            axisLine: {
                lineStyle: { color: '#3a4451' }
            }
        },
        series: series
    };
    
    formatPreferencesChart.setOption(option, true);
}

function updateDiscoveryChart() {
    const data = currentData.discoverySources || [];
    
    if (data.length === 0) {
        discoveryChart.setOption({
            title: {
                text: 'No discovery data yet',
                left: 'center',
                top: 'center',
                textStyle: {
                    color: '#999',
                    fontSize: 14
                }
            }
        }, true);
        return;
    }
    
    const sourceLabels = {
        'search': 'Search',
        'book_detail': 'Book Detail',
        'series': 'Series Page',
        'author': 'Author Page',
        'browse': 'Browse',
        'shelf': 'Shelf',
        'category': 'Category',
        'direct': 'Direct Link'
    };
    
    const option = {
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c} ({d}%)'
        },
        legend: {
            orient: 'vertical',
            right: '5%',
            top: 'center',
            textStyle: {
                color: '#fff'
            }
        },
        series: [{
            type: 'pie',
            radius: ['40%', '70%'],
            center: ['40%', '50%'],
            data: data.map(([source, count]) => ({
                name: sourceLabels[source] || source,
                value: count
            })),
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(255, 152, 0, 0.5)'
                }
            },
            itemStyle: {
                borderRadius: 8,
                borderColor: '#1a2332',
                borderWidth: 2
            },
            label: {
                color: '#fff'
            }
        }]
    };
    
    discoveryChart.setOption(option, true);
}

function updateDeviceChart() {
    const data = currentData.deviceBreakdown || [];
    
    if (data.length === 0) {
        deviceChart.setOption({
            title: {
                text: 'No device data yet',
                left: 'center',
                top: 'center',
                textStyle: {
                    color: '#999',
                    fontSize: 14
                }
            }
        }, true);
        return;
    }
    
    const deviceIcons = {
        'desktop': 'ğŸ–¥ï¸',
        'mobile': 'ğŸ“±',
        'tablet': 'ğŸ“±',
        'unknown': 'â“'
    };
    
    const deviceColors = {
        'desktop': '#2196f3',
        'mobile': '#ff9800',
        'tablet': '#4caf50',
        'unknown': '#999'
    };
    
    const option = {
        tooltip: {
            trigger: 'item',
            formatter: (params) => {
                const icon = deviceIcons[params.name] || 'â“';
                return `${icon} ${params.name.charAt(0).toUpperCase() + params.name.slice(1)}: ${params.value} (${params.percent}%)`;
            }
        },
        legend: {
            orient: 'vertical',
            right: '5%',
            top: 'center',
            textStyle: {
                color: '#fff'
            },
            formatter: (name) => {
                const icon = deviceIcons[name] || 'â“';
                return `${icon} ${name.charAt(0).toUpperCase() + name.slice(1)}`;
            }
        },
        series: [{
            type: 'pie',
            radius: ['50%', '75%'],
            center: ['40%', '50%'],
            data: data.map(([device, count]) => ({
                name: device,
                value: count,
                itemStyle: {
                    color: deviceColors[device] || '#999'
                }
            })),
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            },
            label: {
                show: false
            },
            labelLine: {
                show: false
            }
        }]
    };
    
    deviceChart.setOption(option, true);
}

function updateFailedLogins() {
    const data = currentData.failedLogins || [];
    const count = data.length > 0 ? data.reduce((sum, d) => sum + d[3], 0) : 0;
    
    document.getElementById('failed-logins-count').textContent = count;
    
    if (data.length === 0) {
        document.getElementById('failed-logins-list').innerHTML = '<p style="text-align: center; color: #4caf50; padding: 20px;">âœ“ No failed attempts</p>';
        return;
    }
    
    const listHtml = data.map(([ip, username, timestamp, attempts]) => {
        const date = new Date(timestamp);
        const formattedDate = date.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        const badgeColor = attempts > 5 ? '#f44336' : attempts > 2 ? '#ff9800' : '#999';
        
        return `
            <div style="padding: 8px; border-bottom: 1px solid #3a4451; font-size: 0.85em;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #fff; font-weight: 500;">${ip}</span>
                    <span style="background: ${badgeColor}; color: #fff; padding: 2px 8px; border-radius: 12px; font-size: 0.9em;">${attempts}Ã—</span>
                </div>
                <div style="color: #999; font-size: 0.9em; margin-top: 4px;">
                    ${username} â€¢ ${formattedDate}
                </div>
            </div>
        `;
    }).join('');
    
    document.getElementById('failed-logins-list').innerHTML = listHtml;
}

function updateTopLists() {
    // Check if we're in single user mode
    const urlParams = new URLSearchParams(window.location.search);
    const selectedUserId = urlParams.get('user_id');
    
    if (selectedUserId) {
        // Show Most Active Days instead of Top Users
        const daysHtml = currentData.topUsers.length > 0 
            ? currentData.topUsers.map(([date, count]) => {
                // Format date nicely
                const dateObj = new Date(date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                });
                
                return `
                    <div class="top-item">
                        <span class="top-item-name">ğŸ“† ${formattedDate}</span>
                        <span class="top-item-value">${count}</span>
                    </div>
                `;
            }).join('')
            : '<p style="text-align: center; color: #999; padding: 20px;">No activity data yet</p>';
        document.getElementById('most-active-days-list').innerHTML = daysHtml;
    } else {
        // Show Top Users
        const usersHtml = currentData.topUsers.length > 0 
            ? currentData.topUsers.map(([userId, name, count]) => {
                const profileImage = userProfiles[name];
                const avatar = profileImage 
                    ? `<img src="${profileImage}" class="user-avatar" alt="${name}">` 
                    : 'ğŸ‘¤';
                
                // Make username clickable for admins
                const nameDisplay = isAdmin 
                    ? `<a href="/admin/user/${userId}">${name}</a>` 
                    : name;
                
                return `
                    <div class="top-item">
                        <span class="top-item-name">${avatar} ${nameDisplay}</span>
                        <span class="top-item-value">${count}</span>
                    </div>
                `;
            }).join('')
            : '<p style="text-align: center; color: #999; padding: 20px;">No user activity yet</p>';
        document.getElementById('top-users-list').innerHTML = usersHtml;
    }
    
    // Top Books
    const booksHtml = currentData.topBooks.length > 0
        ? currentData.topBooks.map(([title, id, count]) => `
            <div class="top-item">
                <span class="top-item-name">ğŸ“š <a href="/book/${id}">${title}</a></span>
                <span class="top-item-value">${count}</span>
            </div>
        `).join('')
        : '<p style="text-align: center; color: #999; padding: 20px;">No popular books yet</p>';
    document.getElementById('top-books-list').innerHTML = booksHtml;
    
    // Recent Searches
    const searchesHtml = currentData.recentSearches.length > 0
        ? currentData.recentSearches.map(([term, timestamp, user]) => `
            <div class="search-term">
                "${term}"
                <span class="timestamp">${timestamp.split('T')[0]}</span>
            </div>
        `).join('')
        : '<p style="text-align: center; color: #999; padding: 20px;">No searches yet</p>';
    document.getElementById('recent-searches-list').innerHTML = searchesHtml;
}

function updateSessionDuration() {
    const data = currentData.sessionDuration || { average_minutes: 0, distribution: [] };
    
    // Update metric card
    const avgMin = data.average_minutes || 0;
    document.getElementById('avg-session-duration').textContent = avgMin > 0 ? `${avgMin} min` : '0 min';
    
    // Update histogram chart
    if (data.distribution && data.distribution.length > 0) {
        const buckets = data.distribution.map(d => d[0]);
        const counts = data.distribution.map(d => d[1]);
        
        sessionDurationChart.setOption({
            tooltip: {
                trigger: 'axis',
                backgroundColor: 'rgba(0,0,0,0.8)',
                textStyle: { color: '#fff' },
                formatter: (params) => {
                    const p = params[0];
                    return `${p.name}-${p.name + 5} min: ${p.value} sessions`;
                }
            },
            grid: {
                left: '10%',
                right: '5%',
                bottom: '15%',
                top: '10%'
            },
            xAxis: {
                type: 'category',
                data: buckets,
                name: 'Minutes',
                nameLocation: 'middle',
                nameGap: 30,
                axisLabel: {
                    color: '#fff',
                    rotate: 45
                },
                axisLine: { lineStyle: { color: '#3a4451' } }
            },
            yAxis: {
                type: 'value',
                name: 'Sessions',
                axisLabel: { color: '#fff' },
                splitLine: { lineStyle: { color: '#3a4451' } }
            },
            series: [{
                type: 'bar',
                data: counts,
                itemStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        { offset: 0, color: '#ff9800' },
                        { offset: 1, color: '#ff5722' }
                    ])
                }
            }]
        }, true);
    } else {
        sessionDurationChart.setOption({
            title: {
                text: 'No session data available',
                left: 'center',
                top: 'center',
                textStyle: { color: '#999', fontSize: 14 }
            }
        }, true);
    }
}

function updateSearchSuccess() {
    const data = currentData.searchSuccess || { 
        total_searches: 0, 
        successful_searches: 0, 
        success_rate: 0, 
        trend: 0 
    };
    
    // Update metric card
    document.getElementById('search-success-rate').textContent = `${data.success_rate}%`;
    document.getElementById('search-success-count').textContent = data.successful_searches;
    document.getElementById('total-searches').textContent = data.total_searches;
    
    // Determine color based on success rate
    let color = '#f44336'; // Red for low
    if (data.success_rate >= 60) color = '#4caf50'; // Green for high
    else if (data.success_rate >= 40) color = '#ff9800'; // Orange for medium
    
    // Update gauge chart
    searchSuccessChart.setOption({
        tooltip: {
            formatter: '{b}: {c}%'
        },
        series: [{
            type: 'gauge',
            startAngle: 180,
            endAngle: 0,
            min: 0,
            max: 100,
            splitNumber: 10,
            axisLine: {
                lineStyle: {
                    width: 15,
                    color: [
                        [0.4, '#f44336'],
                        [0.6, '#ff9800'],
                        [1, '#4caf50']
                    ]
                }
            },
            pointer: {
                width: 5,
                length: '60%'
            },
            axisTick: {
                distance: -15,
                length: 5,
                lineStyle: { color: '#fff', width: 1 }
            },
            splitLine: {
                distance: -15,
                length: 10,
                lineStyle: { color: '#fff', width: 2 }
            },
            axisLabel: {
                color: '#fff',
                distance: 20,
                fontSize: 12
            },
            detail: {
                valueAnimation: true,
                formatter: '{value}%',
                color: color,
                fontSize: 24,
                offsetCenter: [0, '80%']
            },
            data: [{ value: data.success_rate, name: 'Success Rate' }]
        }]
    }, true);
}

function updateShelfActivity() {
    const data = currentData.shelfActivity || [];
    
    const html = data.length > 0
        ? data.map(([shelfName, addCount, removeCount, netChange], index) => {
            const netColor = netChange >= 0 ? '#4caf50' : '#f44336';
            const netSymbol = netChange >= 0 ? '+' : '';
            
            return `
                <div style="
                    background: rgba(255,255,255,0.03);
                    border-left: 3px solid ${netColor};
                    padding: 12px 15px;
                    margin-bottom: 10px;
                    border-radius: 4px;
                    transition: all 0.2s ease;"
                    onmouseover="this.style.background='rgba(255,255,255,0.05)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.03)'">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: 600; color: #fff; font-size: 0.95em;">ğŸ“š ${shelfName}</span>
                        <span style="
                            color: ${netColor};
                            font-weight: 700;
                            font-size: 1.1em;
                            min-width: 45px;
                            text-align: right;">${netSymbol}${netChange}</span>
                    </div>
                    <div style="
                        display: flex;
                        gap: 15px;
                        font-size: 0.8em;
                        padding-left: 22px;">
                        <span style="color: #4caf50; display: flex; align-items: center; gap: 4px;">
                            <span style="font-size: 1.1em;">â–²</span> ${addCount}
                        </span>
                        <span style="color: #f44336; display: flex; align-items: center; gap: 4px;">
                            <span style="font-size: 1.1em;">â–¼</span> ${removeCount}
                        </span>
                    </div>
                </div>
            `;
        }).join('')
        : '<p style="text-align: center; color: #999; padding: 40px 20px;">No shelf activity yet</p>';
    
    document.getElementById('shelf-activity-list').innerHTML = html;
}

function toggleDemoMode() {
    demoMode = !demoMode;
    const button = document.getElementById('demo-button');
    const badge = document.getElementById('demo-badge');
    
    if (demoMode) {
        currentData = generateDemoData();
        button.textContent = 'ğŸ“Š Show Real Data';
        button.classList.add('active');
        badge.style.display = 'inline-block';
    } else {
        currentData = hasRealData ? realData : generateDemoData();
        button.textContent = 'ğŸ¨ Show Demo Data';
        button.classList.remove('active');
        badge.style.display = 'none';
    }
    
    updateAllVisualizations();
}

// CSV Export function
function exportActivityCSV() {
    window.location.href = '/cwa-stats-export-csv/activity' + window.location.search;
}

// User filter handling
function handleUserChange() {
    const userId = document.getElementById('user-filter').value;
    const url = new URL(window.location);
    
    if (userId) {
        url.searchParams.set('user_id', userId);
    } else {
        url.searchParams.delete('user_id');
    }
    
    window.location.href = url.toString();
}

// Date range handling functions
function handlePresetChange() {
    const preset = document.getElementById('date-preset').value;
    const customDates = document.getElementById('custom-dates');
    const warning = document.getElementById('date-warning');
    
    if (preset === 'custom') {
        customDates.style.display = 'flex';
    } else {
        customDates.style.display = 'none';
        
        // Show warning for ranges > 1 year
        if (parseInt(preset) > 365) {
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
        
        // Reload page with new days parameter
        const url = new URL(window.location);
        url.searchParams.delete('start_date');
        url.searchParams.delete('end_date');
        url.searchParams.set('days', preset);
        window.location.href = url.toString();
    }
}

function handleCustomDateChange() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    const warning = document.getElementById('date-warning');
    
    if (startDate && endDate) {
        // Date inputs already provide YYYY-MM-DD format
        const start = new Date(startDate);
        const end = new Date(endDate);
        const days = Math.floor((end - start) / (1000 * 60 * 60 * 24));
        
        // Show warning for ranges > 1 year
        if (days > 365) {
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
        
        // Reload page with custom date range
        const url = new URL(window.location);
        url.searchParams.delete('days');
        url.searchParams.set('start_date', startDate);
        url.searchParams.set('end_date', endDate);
        window.location.href = url.toString();
    }
}

function resetDateRange() {
    // Reset to default 30 days and remove all date and user filter parameters
    const url = new URL(window.location);
    url.searchParams.delete('days');
    url.searchParams.delete('start_date');
    url.searchParams.delete('end_date');
    url.searchParams.delete('user_id');
    window.location.href = url.toString();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Show warning if present
    {% if show_warning %}
    document.getElementById('date-warning').style.display = 'block';
    {% endif %}
    
    initCharts();
});
</script>
