{% extends "layout.html" %}

{% block header %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/query-builder.default.min.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/query_builder.css') }}">
<style>
/* Icon Picker Styles */
.icon-picker-container {
    margin-top: 10px;
}
.icon-picker-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
    gap: 8px;
    max-height: 200px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #f9f9f9;
}
.icon-option {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 45px;
    border: 2px solid transparent;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    background: white;
}
.icon-option:hover {
    border-color: #337ab7;
    background: #e7f3ff;
    transform: scale(1.05);
}
.icon-option.selected {
    border-color: #cc7b19;
    background: #fff3e0;
}
.icon-option i {
    font-size: 24px;
    color: #333;
}
.icon-search {
    margin-bottom: 10px;
}
.selected-icon-preview {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    background: #f5f5f5;
    border-radius: 4px;
    margin-top: 10px;
}
.selected-icon-preview i {
    font-size: 20px;
    color: #cc7b19;
}
/* Preview Results Styles */
.preview-results {
    margin-top: 15px;
    padding: 15px;
    border-radius: 4px;
    display: none;
}
.preview-results.success {
    background: #dff0d8;
    border: 1px solid #d6e9c6;
}
.preview-results.error {
    background: #f2dede;
    border: 1px solid #ebccd1;
}
.preview-book-list {
    list-style: none;
    padding-left: 0;
    margin-top: 10px;
}
.preview-book-list li {
    padding: 5px 0;
    border-bottom: 1px solid #e0e0e0;
}
.preview-book-list li:last-child {
    border-bottom: none;
}
/* Mobile Responsive */
@media (max-width: 767px) {
    .icon-picker-grid {
        grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
        gap: 5px;
    }
    .icon-option {
        height: 40px;
    }
    .icon-option i {
        font-size: 20px;
    }
}
/* Help Panel Styles */
.help-panel {
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 20px;
}
.help-panel .panel-heading {
    cursor: pointer;
    user-select: none;
}
.help-panel .panel-heading:hover {
    background: #f0f0f0;
}
.help-content {
    margin-top: 15px;
}
.help-example {
    background: white;
    padding: 10px;
    border-left: 3px solid #cc7b19;
    margin: 10px 0;
}
</style>
{% endblock %}

{% block body %}
<div class="discover">
    <div class="container-fluid">
        <h2>{{ title }}</h2>
        
        <!-- Help Panel -->
        <div class="panel panel-default help-panel">
            <div class="panel-heading" onclick="$('#help-content').slideToggle();">
                <h4 class="panel-title">
                    <i class="fa fa-question-circle"></i> What are Magic Shelves? 
                    <small class="pull-right"><i class="fa fa-chevron-down"></i></small>
                </h4>
            </div>
            <div id="help-content" class="help-content" style="display: none;">
                <p><strong>Magic Shelves</strong> are dynamic shelves that automatically populate based on rules you define. No manual organization needed!</p>
                
                <div class="help-example">
                    <strong>Example:</strong> Create a "Recently Added" shelf that shows all books added in the last 30 days:
                    <ul>
                        <li>Field: <code>Date Added</code></li>
                        <li>Operator: <code>greater than</code></li>
                        <li>Value: <code>30 days ago</code></li>
                    </ul>
                </div>
                
                <p><strong>Tips:</strong></p>
                <ul>
                    <li>Use the <strong>+ Rule</strong> button to add more conditions</li>
                    <li>Use the <strong>+ Group</strong> button to create nested AND/OR logic</li>
                    <li>Click <strong>Preview Rules</strong> to see what books match before saving</li>
                    <li>Best experienced on desktop/tablet (mobile view is limited)</li>
                </ul>
            </div>
        </div>

        <!-- Main Form -->
        <div class="panel panel-default">
            <div class="panel-body">
                {% if shelf and shelf.is_system %}
                <div class="alert alert-info">
                    <i class="fa fa-info-circle"></i>
                    <strong>{{_('System Template')}}</strong>: {{_('This is a pre-configured template shelf. You can edit it freely, or')|safe}} 
                    <button type="button" class="btn btn-xs btn-primary" id="duplicate-shelf-btn">
                        <i class="fa fa-copy"></i> {{_('Duplicate')}}
                    </button> 
                    {{_('to create a copy you can modify.')}}
                </div>
                {% endif %}
                
                <form id="magic-shelf-form">
                    <!-- Shelf Name -->
                    <div class="form-group">
                        <label for="shelf-name">
                            Shelf Name <span class="text-danger">*</span>
                            <i class="fa fa-question-circle" data-toggle="tooltip" title="Give your shelf a descriptive name (max 100 characters)"></i>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="shelf-name" 
                               value="{{ shelf.name if shelf else '' }}" 
                               maxlength="100"
                               placeholder="e.g., Recently Added, Highly Rated, Unread Sci-Fi"
                               required>
                        <small class="form-text text-muted">
                            <span id="char-count">0</span>/100 characters
                        </small>
                    </div>

                    <!-- Icon Picker -->
                    <div class="form-group">
                        <label for="shelf-icon">
                            Shelf Icon
                            <i class="fa fa-question-circle" data-toggle="tooltip" title="Choose an icon that represents your shelf"></i>
                        </label>
                        <input type="hidden" id="shelf-icon" value="{{ shelf.icon if shelf else 'fa-wand-magic-sparkles' }}">
                        
                        <div class="selected-icon-preview">
                            <i class="fa {{ shelf.icon if shelf else 'fa-wand-magic-sparkles' }}" id="selected-icon-display"></i>
                            <span id="selected-icon-name">{{ shelf.icon if shelf else 'fa-wand-magic-sparkles' }}</span>
                        </div>
                        
                        <div class="icon-picker-container">
                            <input type="text" 
                                   class="form-control icon-search" 
                                   id="icon-search" 
                                   placeholder="Search icons...">
                            <div class="icon-picker-grid" id="icon-picker-grid">
                                {% for icon in allowed_icons %}
                                <div class="icon-option" data-icon="{{ icon }}" title="{{ icon }}">
                                    <i class="fa {{ icon }}"></i>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Rules Builder -->
                    <h4>
                        Rules <span class="text-danger">*</span>
                        <i class="fa fa-question-circle" data-toggle="tooltip" title="Define conditions that books must match to appear in this shelf"></i>
                    </h4>
                    <div id="builder"></div>
                    
                    <!-- Preview Results -->
                    <div id="preview-results" class="preview-results">
                        <h5><i class="fa fa-eye"></i> Preview Results</h5>
                        <div id="preview-content"></div>
                    </div>

                    <hr>

                    <!-- Action Buttons -->
                    <div class="form-group">
                        <button type="button" class="btn btn-info" id="preview-btn">
                            <i class="fa fa-eye"></i> Preview Rules
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-save"></i> Save Shelf
                        </button>
                        <a href="{{ url_for('web.index') }}" class="btn btn-default">
                            <i class="fa fa-times"></i> Cancel
                        </a>
                        {% if shelf %}
                        <button type="button" class="btn btn-danger pull-right" id="delete-shelf-btn">
                            <i class="fa fa-trash"></i> Delete Shelf
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% set rules_json = shelf.rules|tojson if shelf and shelf.rules else 'null' %}
{% block js %}
{{ super() }}
<script src="{{ url_for('static', filename='js/query-builder.standalone.min.js') }}"></script>
<script>
$(function() {
    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();
    
    // Character counter for shelf name
    $('#shelf-name').on('input', function() {
        $('#char-count').text($(this).val().length);
    }).trigger('input');
    
    // Icon Picker Logic
    var $iconInput = $('#shelf-icon');
    var $iconDisplay = $('#selected-icon-display');
    var $iconName = $('#selected-icon-name');
    var $iconOptions = $('.icon-option');
    var $iconSearch = $('#icon-search');
    
    // Set initial selected icon
    var currentIcon = $iconInput.val();
    $('.icon-option[data-icon="' + currentIcon + '"]').addClass('selected');
    
    // Icon selection
    $iconOptions.on('click', function() {
        var icon = $(this).data('icon');
        $iconOptions.removeClass('selected');
        $(this).addClass('selected');
        $iconInput.val(icon);
        $iconDisplay.attr('class', 'fa ' + icon);
        $iconName.text(icon);
    });
    
    // Icon search filter
    $iconSearch.on('input', function() {
        var searchTerm = $(this).val().toLowerCase();
        $iconOptions.each(function() {
            var iconName = $(this).data('icon').toLowerCase();
            if (iconName.indexOf(searchTerm) !== -1) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });
    
    // Query Builder Configuration
    var fields = [
        {
            id: 'title', 
            label: 'Title', 
            type: 'string',
            description: 'The book title'
        },
        {
            id: 'author', 
            label: 'Author', 
            type: 'string',
            description: 'Author name'
        },
        {
            id: 'tag', 
            label: 'Tag', 
            type: 'string',
            description: 'Book tags/genres'
        },
        {
            id: 'series', 
            label: 'Series', 
            type: 'string',
            description: 'Series name'
        },
        {
            id: 'publisher', 
            label: 'Publisher', 
            type: 'string',
            description: 'Publisher name'
        },
        {
            id: 'rating', 
            label: 'Rating', 
            type: 'integer', 
            input: 'select', 
            values: {1:1, 2:2, 3:3, 4:4, 5:5, 6:6, 7:7, 8:8, 9:9, 10:10},
            description: 'Book rating (1-10)'
        },
        {
            id: 'pubdate', 
            label: 'Published Date', 
            type: 'date', 
            validation: {format: 'YYYY-MM-DD'},
            description: 'Original publication date'
        },
        {
            id: 'timestamp', 
            label: 'Date Added', 
            type: 'date', 
            validation: {format: 'YYYY-MM-DD'},
            description: 'When book was added to library'
        },
        {
            id: 'has_cover', 
            label: 'Has Cover', 
            type: 'boolean', 
            input: 'radio', 
            values: {1: 'Yes', 0: 'No'},
            description: 'Whether book has cover image'
        },
        {
            id: 'series_index', 
            label: 'Series Index', 
            type: 'double',
            description: 'Position in series'
        },
        {
            id: 'comments', 
            label: 'Description', 
            type: 'string',
            description: 'Book description/comments'
        }
    ];

    var operators = [
        {type: 'equal', optgroup: 'basic'},
        {type: 'not_equal', optgroup: 'basic'},
        {type: 'in', optgroup: 'basic'},
        {type: 'not_in', optgroup: 'basic'},
        {type: 'less', optgroup: 'number'},
        {type: 'less_or_equal', optgroup: 'number'},
        {type: 'greater', optgroup: 'number'},
        {type: 'greater_or_equal', optgroup: 'number'},
        {type: 'between', optgroup: 'number'},
        {type: 'not_between', optgroup: 'number'},
        {type: 'begins_with', optgroup: 'string'},
        {type: 'not_begins_with', optgroup: 'string'},
        {type: 'contains', optgroup: 'string'},
        {type: 'not_contains', optgroup: 'string'},
        {type: 'ends_with', optgroup: 'string'},
        {type: 'not_ends_with', optgroup: 'string'},
        {type: 'is_empty'},
        {type: 'is_not_empty'},
        {type: 'is_null'},
        {type: 'is_not_null'}
    ];

    var rules = {{ rules_json|safe }};

    $('#builder').queryBuilder({
        plugins: ['bt-tooltip-errors'],
        filters: fields,
        operators: operators,
        rules: rules
    });

    // Preview Rules Functionality
    $('#preview-btn').on('click', function() {
        var $btn = $(this);
        var $results = $('#preview-results');
        var $content = $('#preview-content');
        
        var rules = $('#builder').queryBuilder('getRules');
        if (!rules) {
            $results.removeClass('success').addClass('error').show();
            $content.html('<p><strong>Error:</strong> Please define at least one rule.</p>');
            return;
        }
        
        $btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Loading...');
        
        $.ajax({
            url: "{{ url_for('web.preview_magic_shelf') }}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({rules: rules}),
            success: function(response) {
                if (response.success) {
                    $results.removeClass('error').addClass('success').show();
                    var html = '<p><strong><i class="fa fa-check-circle"></i> ' + response.count + ' book(s) match these rules</strong></p>';
                    if (response.sample_books && response.sample_books.length > 0) {
                        html += '<p><small>Sample results:</small></p><ul class="preview-book-list">';
                        response.sample_books.forEach(function(book) {
                            html += '<li>' + book + '</li>';
                        });
                        html += '</ul>';
                    }
                    $content.html(html);
                } else {
                    $results.removeClass('success').addClass('error').show();
                    $content.html('<p><strong>Error:</strong> ' + response.message + '</p>');
                }
            },
            error: function(xhr) {
                $results.removeClass('success').addClass('error').show();
                var message = 'An unexpected error occurred.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    message = xhr.responseJSON.message;
                }
                $content.html('<p><strong>Error:</strong> ' + message + '</p>');
            },
            complete: function() {
                $btn.prop('disabled', false).html('<i class="fa fa-eye"></i> Preview Rules');
            }
        });
    });

    // Form Submission
    $('#magic-shelf-form').on('submit', function(e) {
        e.preventDefault();
        var rules = $('#builder').queryBuilder('getRules');

        if (!rules) {
            alert('Please define at least one rule.');
            return;
        }

        var shelfName = $('#shelf-name').val().trim();
        if (!shelfName) {
            alert('Please enter a shelf name.');
            return;
        }

        var shelfData = {
            name: shelfName,
            icon: $('#shelf-icon').val(),
            rules: rules
        };

        var url = "{{ url_for('web.create_magic_shelf') }}";
        var method = "POST";

        {% if shelf %}
        url = "{{ url_for('web.edit_magic_shelf', shelf_id=shelf.id) }}";
        {% endif %}

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(shelfData),
            success: function(response) {
                if (response.success) {
                    window.location.href = "{{ url_for('web.index') }}";
                } else {
                    alert('Error saving shelf: ' + (response.message || 'Unknown error'));
                }
            },
            error: function(xhr) {
                var message = 'An unexpected error occurred.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    message = xhr.responseJSON.message;
                }
                alert('Error: ' + message);
            }
        });
    });

    // Delete Shelf
    {% if shelf %}
    $('#delete-shelf-btn').on('click', function() {
        if (confirm('Are you sure you want to delete this shelf? This action cannot be undone.')) {
            $.ajax({
                url: "{{ url_for('web.delete_magic_shelf', shelf_id=shelf.id) }}",
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        window.location.href = "{{ url_for('web.index') }}";
                    } else {
                        alert('Error deleting shelf: ' + (response.message || 'Unknown error'));
                    }
                },
                error: function(xhr) {
                    var message = 'An unexpected error occurred.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        message = xhr.responseJSON.message;
                    }
                    alert('Error: ' + message);
                }
            });
        }
    });
    
    // Duplicate Shelf
    $('#duplicate-shelf-btn').on('click', function() {
        var $btn = $(this);
        $btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Duplicating...');
        
        $.ajax({
            url: "{{ url_for('web.duplicate_magic_shelf', shelf_id=shelf.id) }}",
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    // Redirect to edit the new duplicated shelf
                    window.location.href = "{{ url_for('web.edit_magic_shelf', shelf_id=0) }}".replace('/0', '/' + response.shelf_id);
                } else {
                    alert('Error duplicating shelf: ' + (response.message || 'Unknown error'));
                    $btn.prop('disabled', false).html('<i class="fa fa-copy"></i> Duplicate');
                }
            },
            error: function(xhr) {
                var message = 'An unexpected error occurred.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    message = xhr.responseJSON.message;
                }
                alert('Error: ' + message);
                $btn.prop('disabled', false).html('<i class="fa fa-copy"></i> Duplicate');
            }
        });
    });
    {% endif %}
                    }
                    alert('Error: ' + message);
                }
            });
        }
    });
    {% endif %}
});
</script>
{% endblock %}
